### 3.3 分頁系統

分頁系統（Paging System）是現代操作系統中用來管理虛擬記憶體的一種技術，它將虛擬地址空間和物理地址空間分成固定大小的塊，稱為“頁”（Page）和“頁框”（Page Frame），並通過頁表來實現虛擬地址到物理地址的映射。分頁系統能有效解決內存碎片問題，實現高效的內存管理，並提供虛擬記憶體的支持，讓程式可以使用超過物理內存大小的內存。

#### 3.3.1 分頁系統的基本概念

在分頁系統中，虛擬記憶體和物理記憶體都被劃分為大小相同的單位。這些單位分別稱為“頁”（Page）和“頁框”（Page Frame）。虛擬記憶體中的每一個頁面可以映射到物理記憶體中的一個頁框，而這些映射關係由頁表來管理。

1. **頁（Page）**  
   虛擬記憶體中的每一個固定大小的區域稱為頁。頁的大小通常是2的次方數字，如4KB、8KB等。每個頁面都有一個唯一的虛擬地址，這些地址被用來指示程序訪問的內存區域。

2. **頁框（Page Frame）**  
   物理記憶體中的每一個固定大小的區域稱為頁框。與虛擬頁面對應，物理內存也被劃分為相同大小的頁框。頁框的大小與虛擬頁面大小一致。

3. **頁表（Page Table）**  
   頁表是用來存儲虛擬頁面與物理頁框之間映射關係的數據結構。每個虛擬頁面有一個對應的頁表條目，該條目記錄了該虛擬頁面在物理內存中的頁框位置。當處理器訪問虛擬內存地址時，MMU會查詢頁表，並根據映射結果將虛擬地址轉換為物理地址。

4. **頁表基址（Page Table Base Register, PTBR）**  
   在操作系統中，頁表的地址通常會保存在一個稱為頁表基址寄存器（PTBR）的寄存器中。PTBR指向當前進程的頁表的起始位置，當進程上下文切換時，操作系統會更新PTBR，指向新的頁表。

#### 3.3.2 分頁系統的工作原理

分頁系統的工作流程可以分為兩個主要步驟：**虛擬地址到物理地址的轉換**和**頁面錯誤處理**。

1. **虛擬地址到物理地址的轉換**  
   當處理器生成一個虛擬地址時，MMU會將虛擬地址分成兩部分：
   - **頁號（Page Number）**：虛擬地址的高位部分，表示虛擬頁面在虛擬內存中的位置。
   - **頁內偏移（Page Offset）**：虛擬地址的低位部分，表示虛擬頁面內部的具體位置。

   然後，MMU根據頁號查詢頁表，獲得對應的物理頁框號。最後，MMU將物理頁框號與頁內偏移結合，形成最終的物理地址，從而將虛擬地址映射到物理內存。

2. **頁面錯誤處理（Page Fault）**  
   當程序訪問的虛擬頁面不在物理內存中時，MMU會觸發頁面錯誤。頁面錯誤通常是由於該頁面尚未載入內存，或者該頁面被換出到硬碟。在頁面錯誤發生時，操作系統會進行頁面調度，即從輔助存儲設備（如硬碟）將所需的頁面載入到物理內存中。

   頁面錯誤處理通常需要以下步驟：
   - 查找被請求的虛擬頁面。
   - 如果頁面不在物理內存中，將其從磁碟讀取到內存中。
   - 更新頁表，將虛擬頁面的物理地址映射關係設置為最新的物理頁框。

#### 3.3.3 分頁系統的優勢

1. **消除內存碎片**  
   在傳統的連續記憶體分配中，隨著程序的執行和釋放內存，會產生內存碎片，導致記憶體空間無法充分利用。而分頁系統通過將內存分成固定大小的頁面，能夠有效地消除內存碎片問題。無論物理記憶體中分配的區域是否連續，頁面都能夠合理地映射到物理記憶體中的任意位置。

2. **虛擬記憶體支持**  
   分頁系統使得虛擬記憶體成為可能。虛擬記憶體允許程序使用超過物理內存容量的記憶體。操作系統通過頁面交換（Paging）機制，將不常用的頁面從物理內存中移除，並將需要的頁面從磁碟讀取到內存中，實現“超大內存”的效果。

3. **程序隔離與保護**  
   分頁系統能夠提供程序之間的隔離，防止一個程序非法訪問或修改另一程序的記憶體區域。這是因為每個程序的虛擬地址空間被映射到物理內存的不同頁框，互不干擾。這樣可以有效防止程序之間的衝突，提高系統的安全性。

4. **支持多道程序設計**  
   由於分頁系統支持虛擬記憶體，每個程序都可以擁有自己的虛擬地址空間。這使得操作系統可以同時運行多個程序，而每個程序的虛擬記憶體都不會受到其他程序的干擾。

#### 3.3.4 分頁系統的劣勢

1. **頁表管理開銷**  
   分頁系統需要為每個進程維護一個頁表，這會消耗一定的內存資源。尤其是在有大量進程的情況下，頁表的管理可能會帶來較大的開銷。為了減少頁表的存儲需求，操作系統通常會採用分層頁表（如多級頁表）來減少頁表所佔的空間。

2. **頁表查找延遲**  
   每次地址轉換都需要查詢頁表，這會帶來一定的延遲。為了提高效率，現代系統通常使用**快取（TLB）**來加速頁表查找。然而，即使有快取，頁表查找的延遲仍然是一個不可忽視的問題。

3. **頁面錯誤處理的開銷**  
   當發生頁面錯誤時，操作系統需要將頁面從輔助存儲載入到物理內存中，這是相對較慢的操作。頻繁的頁面錯誤會導致較高的I/O負擔，進而影響系統的性能。

#### 小結

分頁系統是現代操作系統中實現虛擬記憶體的重要技術，能有效解決內存碎片、支持多道程序設計、保護程序之間的記憶體隔離等問題。雖然它帶來了一些管理開銷和性能挑戰，但現代操作系統通過使用快取、分層頁表等技術來減少這些問題的影響。分頁系統的引入使得現代計算機能夠更靈活、高效地管理內存資源。