### 3.4 分段系統

分段系統（Segmentation System）是另一種虛擬記憶體管理技術，它與分頁系統不同，分段系統將程序的虛擬地址空間劃分為若干不同的區段（Segment），每個區段具有邏輯上的意圖，如代碼區段、資料區段、堆疊區段等。分段系統更貼近程序的結構，並允許更靈活的內存管理。

#### 3.4.1 分段系統的基本概念

分段系統的基本單位是**區段（Segment）**，每個區段是程序的邏輯組件之一。每個區段通常包含具有相似功能的內存區域，如：

- **代碼段（Code Segment）**：存放程序的執行代碼。
- **資料段（Data Segment）**：存放程序運行過程中使用的靜態資料。
- **堆疊段（Stack Segment）**：存放程序運行過程中動態分配的內存，通常用於函數的調用堆疊。
- **堆區段（Heap Segment）**：存放程序運行時動態分配的內存區域，用於儲存運行時分配的變數和數據結構。

在分段系統中，程序的每個區段都有一個起始地址和長度，因此每個區段在虛擬內存中都是可變大小的。

1. **區段號（Segment Number）**：虛擬地址中的高位部分，用來指示程序中的某個區段。
2. **區段內偏移（Offset）**：虛擬地址中的低位部分，用來指示在該區段內的具體位置。

每個區段都有一個起始地址和長度，操作系統會根據區段號來查詢區段表（Segment Table），該表記錄了每個區段在物理內存中的映射關係。當處理器訪問虛擬地址時，MMU會根據區段號查詢區段表，將虛擬地址轉換為物理地址。

#### 3.4.2 分段系統的工作原理

分段系統的工作原理主要涉及兩個步驟：**虛擬地址到物理地址的轉換**和**區段錯誤處理**。

1. **虛擬地址到物理地址的轉換**  
   虛擬地址由兩部分組成：**區段號**和**區段內偏移**。當處理器生成一個虛擬地址時，MMU會先提取出區段號，根據區段號查詢區段表，獲得該區段的基址（起始地址）和長度。接著，將區段內偏移與區段的基址相加，得到最終的物理地址。

2. **區段錯誤處理（Segment Fault）**  
   當程序訪問的虛擬區段不在物理內存中時，會觸發區段錯誤。這通常是由於該區段尚未載入物理內存，或者該區段被換出到輔助存儲設備（如硬碟）。在區段錯誤發生時，操作系統會將相應的區段從輔助存儲設備載入物理內存中，並更新區段表。

   當區段錯誤發生時，操作系統的處理過程通常如下：
   - 查找缺失的區段。
   - 從磁碟或其他輔助存儲設備將區段載入內存。
   - 更新區段表，將虛擬區段的基址映射到物理內存的某個位置。

#### 3.4.3 分段系統的優勢

1. **與程序結構匹配**  
   分段系統的主要優勢之一是它能夠反映程序的邏輯結構。每個區段都是程序的邏輯單位，這樣可以更自然地對程序進行管理。這樣的結構使得程序的動態分配和釋放內存變得更加靈活，並且更容易理解和管理。

2. **靈活的內存分配**  
   分段系統不要求所有區段的大小相同，每個區段的大小可以根據需求進行動態調整。這使得內存分配更加靈活，避免了固定大小頁面的限制。

3. **支持程序隔離**  
   分段系統能夠有效地實現程序之間的隔離，防止一個程序修改或破壞另一個程序的數據。每個程序的邏輯區段都是獨立的，區段錯誤機制可以有效防止不正確的內存訪問。

#### 3.4.4 分段系統的劣勢

1. **內存碎片問題**  
   雖然分段系統支持靈活的內存分配，但這也可能導致內存碎片的問題。由於每個區段的大小可以是變動的，當區段被釋放後，可能會留下不連續的小空間，這些空間無法被有效利用，進而導致內存碎片。

2. **管理開銷**  
   分段系統需要維護一個區段表，該表需要記錄每個區段的起始地址、長度以及其他相關信息。在系統中有大量進程時，管理這些區段表會帶來一定的開銷。

3. **區段錯誤處理的開銷**  
   和分頁系統類似，當發生區段錯誤時，需要將區段從磁碟載入內存，這會帶來一定的I/O開銷。如果程序經常出現區段錯誤，會嚴重影響系統的性能。

#### 3.4.5 分段與分頁的比較

分段系統和分頁系統都是為了解決內存管理問題，但它們的設計理念和實現方式有所不同：

| 特點            | 分頁系統                        | 分段系統                        |
|-----------------|---------------------------------|---------------------------------|
| 基本單位        | 頁（Page）                      | 區段（Segment）                 |
| 地址結構        | 虛擬頁號 + 頁內偏移              | 區段號 + 區段內偏移             |
| 內存分配        | 固定大小頁面，無內存碎片問題     | 可變大小區段，可能產生碎片     |
| 優勢            | 內存管理簡單，支持虛擬內存       | 與程序結構匹配，靈活的內存分配  |
| 劣勢            | 地址轉換開銷，可能導致性能下降   | 內存碎片，管理開銷較高         |

#### 小結

分段系統提供了一種靈活且貼近程序結構的內存管理方式，它允許變動大小的區段，並且能夠支持程序的邏輯結構。然而，分段系統可能會遇到內存碎片問題，並且在管理區段表和處理區段錯誤時會帶來額外的開銷。與分頁系統相比，分段系統的內存分配更靈活，但也更加複雜。分段系統與分頁系統常常會結合使用，以充分發揮各自的優勢。