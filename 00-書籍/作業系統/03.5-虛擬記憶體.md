### 3.5 虛擬記憶體

虛擬記憶體（Virtual Memory）是一種內存管理技術，它使得應用程序能夠使用比實際物理內存更多的內存。虛擬記憶體技術允許程序運行時超出物理內存的限制，通過將不常用的數據從物理內存換出到磁碟或其他輔助存儲設備（如硬碟），來擴展可用的內存空間。這樣，虛擬記憶體使得每個程序都能夠擁有一個連續且完整的內存地址空間，從而簡化了內存管理並提高了系統的效率和靈活性。

#### 3.5.1 虛擬記憶體的工作原理

虛擬記憶體的基本概念是將虛擬地址空間與物理地址空間進行映射，這種映射是由操作系統和硬體共同完成的。每個程序都有一個虛擬地址空間，該空間是連續的，並且比實際的物理內存大。當程序需要訪問內存時，虛擬地址會被轉換為物理地址，這是由**記憶體管理單元（MMU）**完成的。

1. **虛擬地址與物理地址映射**  
   虛擬記憶體使用頁表（Page Table）來進行虛擬地址到物理地址的映射。頁表中包含了每個虛擬頁面的物理地址映射關係。MMU在每次訪問虛擬內存時，都會查詢頁表，將虛擬地址轉換為物理地址。

2. **頁面置換（Page Replacement）**  
   當虛擬記憶體的使用超過物理內存容量時，操作系統會將不常用的頁面換出到輔助存儲設備（例如硬碟），並將需要的頁面從輔助存儲設備載入到物理內存中。這一過程被稱為頁面置換。頁面置換通常會引起**頁面錯誤（Page Fault）**，這是一種內存訪問錯誤，意味著所需的頁面並未在物理內存中。

#### 3.5.2 頁面錯誤處理

當程序訪問的虛擬頁面不在物理內存中時，就會發生頁面錯誤。頁面錯誤會由操作系統處理，具體步驟如下：

1. **觸發頁面錯誤**：當CPU發現某個虛擬地址所對應的頁面不在物理內存中時，會觸發頁面錯誤中斷。
   
2. **操作系統處理頁面錯誤**：
   - 操作系統查找該頁面的物理地址映射，如果映射是有效的，則將頁面從輔助存儲設備載入物理內存。
   - 如果物理內存已滿，操作系統會選擇一個不常用的頁面進行置換。置換的頁面會被寫回輔助存儲設備，並將新的頁面載入物理內存。

3. **更新頁表**：頁面載入後，操作系統會更新頁表，記錄虛擬頁面與新載入物理頁面之間的映射關係。

4. **恢復程序執行**：頁面載入並映射完成後，程序可以繼續執行，並且訪問到原本缺失的頁面。

頁面錯誤的處理是虛擬記憶體系統中的一個關鍵過程，雖然頁面錯誤的發生會導致性能下降，但操作系統和硬體的高效協作可以最小化頁面錯誤的影響。

#### 3.5.3 虛擬記憶體的優勢

1. **擴展內存容量**  
   虛擬記憶體使得程序能夠使用超過物理內存容量的內存空間。這是通過將不活躍的頁面換出到硬碟等輔助存儲設備來實現的。這樣，即使物理內存不足，也可以運行更多的程序或處理更大的數據集。

2. **簡化內存管理**  
   程序視圖中的地址空間是連續的，這使得程序設計更簡單，開發人員不需要擔心物理內存的分配問題。操作系統會自動處理虛擬地址與物理地址的映射關係。

3. **程序隔離與保護**  
   虛擬記憶體系統為每個程序提供了獨立的虛擬地址空間，從而達到程序之間的隔離。每個程序只能訪問自己的虛擬內存，這防止了一個程序修改或破壞其他程序的數據，提升了系統的安全性和穩定性。

4. **靈活的內存管理**  
   虛擬記憶體允許操作系統動態地將不常用的內存頁面換出到磁碟中，這樣可以有效地使用物理內存，並在需要時迅速將頁面載入內存，從而保持系統的高效運行。

#### 3.5.4 虛擬記憶體的劣勢

1. **性能開銷**  
   虛擬記憶體系統的性能開銷主要來自於頁面錯誤的處理和頁面置換的過程。每當程序訪問的頁面不在物理內存中時，操作系統需要從磁碟中讀取該頁面，這比從內存中直接讀取要慢得多。因此，頻繁的頁面錯誤會導致顯著的性能下降，這種情況被稱為**頁面抖動（Thrashing）**。

2. **磁碟I/O開銷**  
   虛擬記憶體需要頻繁進行磁碟I/O操作，以將頁面載入或換出內存。磁碟I/O速度遠低於內存，這使得大量的磁碟操作會顯著拖慢系統的速度，尤其是在內存不足的情況下。

3. **內存碎片問題**  
   雖然虛擬記憶體提供了比物理內存更大的空間，但由於內存頁面大小是固定的，這可能會導致內存碎片。當某些程序需要大量內存而其他程序需要的內存較少時，內存中可能會有一些未使用的頁面，這些頁面無法有效分配給其他程序。

#### 3.5.5 頁面置換演算法

頁面置換演算法（Page Replacement Algorithms）用於選擇哪些頁面應該被換出到輔助存儲設備，並根據算法載入新的頁面。常見的頁面置換算法包括：

- **最近最少使用（LRU, Least Recently Used）**  
   選擇最近最少使用的頁面進行置換。這種算法假設最近使用的頁面可能會再次使用，從而將不常使用的頁面置換出去。

- **先進先出（FIFO, First In First Out）**  
   依照頁面進入內存的順序來進行置換，最早進入內存的頁面最先被置換。這種方法簡單，但可能不是最有效的。

- **最佳算法（Optimal Algorithm）**  
   根據未來的訪問情況來選擇應該置換的頁面。這種算法能夠達到最小的頁面錯誤率，但需要預測未來的頁面訪問模式，這在實際應用中是不現實的。

- **時鐘算法（Clock Algorithm）**  
   類似於LRU，但使用圓形隊列來實現，適合硬體實現。每個頁面都有一個參考位，當頁面被訪問時，參考位會被設置為1。當頁面需要被置換時，會循環檢查參考位為0的頁面，並將其置換出去。

#### 小結

虛擬記憶體技術使得程序能夠超出物理內存的限制進行運行，並通過頁面置換等機制動態管理內存。它不僅擴展了可用內存的大小，還簡化了內存管理，並提高了系統的靈活性和安全性。然而，虛擬記憶體的使用也帶來了性能上的挑戰，特別是頁面錯誤和磁碟I/O的開銷。因此，設計高效的頁面置換算法和減少頁面錯誤的發生對於提升虛擬記憶體系統的性能至關重要。