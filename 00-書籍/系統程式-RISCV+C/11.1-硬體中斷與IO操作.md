
#### 1. **硬體中斷與 I/O 操作**

在現代作業系統中，硬體中斷和 I/O 操作是系統與外部裝置溝通的核心機制。裝置驅動程式（Device Driver）負責管理這些硬體裝置並處理它們的 I/O 請求，保證系統能夠有效、即時地對來自外部裝置的資料交換作出反應。硬體中斷作為一種高效的機制，能夠在裝置需要注意時立即將處理器的執行轉移到相應的中斷處理程式，進而進行 I/O 操作。

### 1.1 **硬體中斷概述**

硬體中斷是一種異步的事件，當外部硬體需要處理時，它會向處理器發送中斷請求。中斷可以來自各種硬體裝置，如鍵盤、網路卡、磁碟、顯示卡等。中斷處理的主要過程包括以下幾個步驟：

1. **中斷請求（IRQ，Interrupt Request）**：
   裝置向處理器發送中斷請求信號。處理器收到中斷信號後，會停止當前執行的指令，保存上下文並跳轉到中斷處理程式。

2. **中斷服務例程（ISR，Interrupt Service Routine）**：
   當中斷發生時，處理器會根據中斷向量表（Interrupt Vector Table）找到對應的中斷服務例程。這些例程負責處理具體的硬體中斷，例如讀取資料、處理錯誤等。

3. **中斷返回**：
   一旦中斷處理完成，控制權會返回到中斷前的程序繼續執行。這時處理器會恢復原來的上下文。

#### 1.2 **中斷的類型**

1. **硬體中斷（Hardware Interrupts）**：
   由硬體裝置發起，通知處理器需要處理的事件。例如，外部裝置的資料到達、按鍵被按下等。

2. **軟體中斷（Software Interrupts）**：
   由軟體觸發，通常用於實現系統呼叫或操作系統內部的某些功能。當用戶程式需要訪問特權模式（如操作系統內核）時，會觸發軟體中斷。

3. **時鐘中斷（Timer Interrupts）**：
   由計時器硬體發起，用於實現時間片輪轉（time-slicing）或定時任務。

#### 1.3 **中斷控制與優先級**

處理器通常具有中斷控制器（如 PIC，Programmable Interrupt Controller 或 APIC，Advanced Programmable Interrupt Controller），該控制器用來處理來自多個裝置的中斷請求。中斷控制器的主要作用是決定哪些中斷應該被接受，以及當多個中斷同時發生時，如何確定處理的順序。

- **中斷優先級**：不同的中斷有不同的優先級，當多個中斷同時發生時，中斷控制器根據優先級決定處理順序。
- **中斷屏蔽**：當某些中斷優先處理時，系統可以選擇屏蔽（禁用）一些低優先級的中斷，避免處理過多的中斷。

#### 1.4 **I/O 操作**

I/O 操作指的是計算機與外部設備（如磁碟、鍵盤、顯示器等）之間的資料傳輸過程。I/O 操作的類型通常可以分為兩種：

1. **同步 I/O 操作**：
   在這種模式下，I/O 操作會阻塞進程直到操作完成。應用程式發起 I/O 請求後，會等待設備操作結束，然後才繼續執行。這種方式的好處是簡單，缺點是效率較低，因為 CPU 在等待 I/O 操作完成時無法執行其他任務。

2. **異步 I/O 操作**：
   異步 I/O 允許應用程式在發起 I/O 請求後立即繼續執行，而不需要等待 I/O 操作完成。當 I/O 操作完成後，會通知應用程式或者通過回調函數（callback function）進行處理。這種方式能提高系統的整體效率，適合處理大量並行 I/O 請求的情境。

#### 1.5 **裝置驅動程式中的 I/O 操作**

裝置驅動程式是操作系統與硬體裝置之間的橋梁，負責控制硬體裝置並管理 I/O 操作。裝置驅動程式通過以下方式處理 I/O 操作：

1. **初始化裝置**：驅動程式在啟動時負責初始化硬體裝置，設定中斷向量、中斷優先級、I/O 埠等基本參數。

2. **處理 I/O 請求**：
   - 當操作系統發起 I/O 請求時，驅動程式會根據請求類型（讀取或寫入）來選擇適當的 I/O 操作。
   - 在處理過程中，驅動程式會監控裝置的狀態，通過輪詢（polling）或中斷機制來檢查裝置是否準備好進行操作。

3. **異常處理**：裝置驅動程式需要處理各種錯誤情況，如設備忙碌、傳輸錯誤等。它需要根據錯誤類型進行重試或報錯。

#### 1.6 **範例：鍵盤中斷與 I/O 操作**

假設我們設計一個簡單的鍵盤驅動程式，它通過中斷處理器來處理鍵盤輸入。

1. 當按鍵被按下時，鍵盤硬體會向處理器發送中斷信號。
2. 處理器接收到中斷信號後，會跳轉到鍵盤中斷服務例程（ISR）。
3. ISR 會讀取鍵盤緩衝區中的按鍵代碼，並將其轉換為相應的字符。
4. 驅動程式會將該字符傳遞給操作系統或應用程式，並通知其處理完成。

```c
#include <stdio.h>
#include <stdint.h>

#define KEYBOARD_IRQ 1  // 假設鍵盤中斷號為 1

// 假設鍵盤資料緩衝區
uint8_t keyboardBuffer[128];
int bufferIndex = 0;

// 假設鍵盤中斷服務例程
void keyboardISR() {
    uint8_t scancode = inb(0x60);  // 從鍵盤端口讀取掃描碼
    keyboardBuffer[bufferIndex++] = scancode;

    // 假設將掃描碼轉換為字符，並打印
    printf("Key Pressed: %c\n", scancode); // 實際應該映射掃描碼為字符
}

// 模擬讀取 I/O 埠（用於硬體 I/O 操作）
uint8_t inb(uint16_t port) {
    // 假設從指定端口讀取資料
    return 0x1E;  // 例如，返回字母 'A' 的掃描碼
}

// 主程序
int main() {
    // 設定中斷向量
    setInterruptVector(KEYBOARD_IRQ, keyboardISR);

    // 模擬中斷觸發
    keyboardISR();  // 當按鍵被按下，ISR 被調用

    return 0;
}
```

### 小結

在本節中，我們介紹了硬體中斷、I/O 操作及裝置驅動程式的設計原則。裝置驅動程式是操作系統的重要組成部分，它負責處理與硬體裝置之間的交互。在設計裝置驅動程式時，理解中斷機制、I/O 操作的流程以及如何處理這些操作是至關重要的。