### 動態與靜態連結器的架構

在系統軟體中，**連結器（Linker）** 負責將編譯後的物件檔案（object files）合併成可執行檔案或庫。根據連結的時間和方式，連結器可以分為兩類：**靜態連結器**（Static Linker）與**動態連結器**（Dynamic Linker）。這兩種連結方式有各自的架構和工作原理。

---

### 1. **靜態連結器（Static Linker）**

靜態連結器在編譯過程中將所有的物件檔案和靜態庫文件合併為一個最終的可執行檔案，所有的符號解析和重定位在編譯時完成。靜態連結器的架構相對簡單，且在運行時不需要額外的庫或資源，因為所有依賴的代碼和資料都已經被靜態地嵌入到最終的可執行檔中。

#### 靜態連結的過程

1. **符號解析（Symbol Resolution）**：靜態連結器首先遍歷物件檔案中的符號表，查找外部符號的定義和引用，並將未解析的符號與其他物件檔案中的定義進行匹配。這個過程會確保程式中的所有符號都指向正確的記憶體位置。

2. **重定位（Relocation）**：在符號解析之後，靜態連結器會根據物件檔案的地址分配策略，更新程式中的相對地址和符號地址，將它們轉換為絕對地址。重定位表通常包含需要調整地址的所有位置，連結器會根據這些表條目修改程式碼和資料。

3. **生成可執行檔（Executable Generation）**：靜態連結器完成符號解析與重定位後，將物件檔案的內容合併為一個完整的可執行檔案。該檔案包括所有代碼和資料，並且不依賴於外部庫。

靜態連結的架構圖如下：

```
[Source Files] --> [Compiler] --> [Object Files] 
         |                         |
         v                         v
[Static Linker] --> [Executable File] (包含所有代碼和庫)
```

#### 優缺點

- **優點**：
  - 不依賴於外部庫，程式執行時不需要額外的動態庫載入。
  - 在某些情況下，靜態連結可以提高執行效能，因為所有的符號和代碼都已經被編譯為最終的可執行檔案。

- **缺點**：
  - 可執行檔案較大，因為所有依賴的代碼和庫都被嵌入其中。
  - 不易更新，若程式需要更新，則必須重新編譯所有依賴的代碼。

---

### 2. **動態連結器（Dynamic Linker）**

動態連結器（又稱為動態裝載器）在程式執行時進行符號解析和重定位，並且可以在執行期間載入動態庫（Dynamic Libraries，或稱為共享庫）。與靜態連結器不同，動態連結器不會在編譯階段將所有的依賴嵌入到可執行檔案中，而是根據需求在程式執行期間載入外部庫，並解決符號的地址。

#### 動態連結的過程

1. **延遲綁定（Lazy Binding）**：當程式啟動時，動態連結器會首先載入可執行檔案中的動態庫位置，而不會立即解析所有的符號。在程式執行過程中，只有當程式調用一個外部符號時，動態連結器才會動態解析並載入相應的庫。

2. **符號解析（Symbol Resolution）**：動態連結器會檢查程式中的符號引用，並查找對應的動態庫中的符號定義。這通常通過符號表來完成。

3. **重定位（Relocation）**：在符號解析後，動態連結器會進行地址重定位，將符號地址轉換為運行時的實際地址。這通常是根據載入的庫的基地址和位置偏移來計算。

4. **動態庫載入（Library Loading）**：動態連結器根據需要載入共享庫，這些庫可以是系統庫或第三方庫。當程式運行到需要調用某個外部符號時，動態連結器會載入對應的共享庫，並將符號地址綁定到程式中。

動態連結的架構圖如下：

```
[Source Files] --> [Compiler] --> [Object Files] 
         |                         |
         v                         v
[Dynamic Linker] <--> [Shared Libraries]
                |
                v
       [Executable File] (包含外部庫的引用)
```

#### 優缺點

- **優點**：
  - 可執行檔案通常較小，因為它不包含所有的庫代碼，而是依賴於共享庫。
  - 共享庫可以在多個程式之間共享，節省系統資源。
  - 程式和庫可以分開更新，無需重新編譯整個應用程序，只需更新動態庫即可。

- **缺點**：
  - 程式啟動時需要額外的時間來載入和綁定庫，這可能導致啟動速度變慢。
  - 如果程式依賴於特定版本的動態庫，可能會遇到庫版本不兼容的問題，這就是所謂的“地獄依賴”（dependency hell）。

---

### 動態與靜態連結器的架構比較

| 特徵                   | 靜態連結器                             | 動態連結器                             |
|------------------------|--------------------------------------|--------------------------------------|
| **連結時間**            | 編譯時完成                           | 執行時完成                           |
| **符號解析時間**        | 編譯時解析所有符號                   | 執行時延遲綁定，按需解析符號         |
| **可執行檔案大小**      | 大，包含所有代碼和庫                 | 小，只有外部庫的引用，庫分開儲存     |
| **庫的共享性**          | 無法共享庫                            | 可以共享庫，節省內存和磁碟空間       |
| **執行效能**            | 一般較快，無需額外的載入時間         | 初期可能較慢，因為需要載入動態庫     |
| **更新與維護**          | 更新時需要重新編譯所有代碼           | 只需更新動態庫，不必重新編譯程式碼   |

### 總結

靜態連結器和動態連結器的架構各有優劣，選擇使用哪一種取決於程式的需求和使用場景。靜態連結器適合需要完整控制和較高執行效能的情況，而動態連結器則適合需要減少磁碟空間佔用並允許程式與庫分開更新的情境。