### 4.4 符號表的設計與實現

符號表（Symbol Table）是編譯器中用來儲存程式中各種符號（例如變量、函數、類型等）資訊的數據結構。符號表的作用是將源程式中的符號名稱與其相關的屬性（如類型、作用域、位置等）進行映射，這樣編譯器便可以在後續的語法分析、語義分析、代碼生成等階段使用這些信息。

符號表通常在語義分析階段被建立並更新，在編譯過程中的多個階段都會進行查詢和修改。符號表的設計和實現對編譯器的效率和可擴展性至關重要。以下是符號表設計和實現的幾個關鍵要素。

#### 1. 符號表的結構

符號表本質上是一種數據結構，主要用來儲存符號的相關信息。最常見的符號表結構包括哈希表（Hash Table）、平衡樹（如紅黑樹）和鏈表。這些結構的選擇取決於編譯器對查詢和插入操作的效率要求。

- **哈希表**：哈希表是符號表中最常見的實現方式之一，因為它可以提供常數時間的查詢和插入操作。每個符號名稱（如變量名）經過哈希函數處理後對應到一個哈希桶，並儲存與符號相關的資訊。哈希表的缺點是在處理哈希衝突時，性能可能會下降。

- **平衡樹**：對於需要支持範圍查詢或有序遍歷的情況，使用平衡樹（如紅黑樹或AVL樹）會更有效。這些樹結構可以提供對符號的有序遍歷，並且保證查詢、插入和刪除操作的時間複雜度是O(log n)。

- **鏈表**：在簡單的編譯器設計中，符號表有時候會使用鏈表來存儲符號。這種方法實現簡單，但查詢速度較慢，並且無法保證符號表內部的有序性。

#### 2. 符號表的功能

符號表的主要功能是儲存和查詢符號信息。具體來說，符號表應該提供以下幾個基本操作：

- **插入符號**：當編譯器遇到新的符號（如變量、函數或類型）時，會將其插入符號表。插入過程需要提供符號的名稱、類型、作用域以及其他相關屬性。

- **查詢符號**：編譯器在後續的分析過程中需要查詢符號表，以確定某個符號是否已經被定義以及它的屬性。例如，當進行類型檢查時，編譯器需要查詢變量是否已經聲明，以及其類型是什麼。

- **刪除符號**：當符號的作用域結束時，例如當某個變量的作用域結束時，編譯器應該刪除該符號，釋放資源。

- **更新符號**：在符號表中，同一符號可能會有多個屬性需要更新（例如類型、作用域或位置等）。當發現符號屬性變化時，編譯器應更新符號表中的相應條目。

- **查找符號的範圍**：符號表應支持根據符號名稱查詢符號的作用域。例如，在多層嵌套的作用域中，符號表應能夠正確區分不同作用域中的符號。

#### 3. 符號表的作用域管理

符號表通常會涉及到不同的作用域（Scope），因此設計時需要考慮作用域管理。作用域是符號可見的範圍，通常分為兩種：靜態作用域和動態作用域。

- **靜態作用域（Static Scope）**：在靜態作用域中，符號的可見性取決於程式的結構，編譯器根據源碼中的程式結構來確定符號的可見範圍。大多數編程語言都採用靜態作用域，如C、Java等。符號表的設計需要能夠處理不同作用域中的符號，並支持作用域的嵌套。

- **動態作用域（Dynamic Scope）**：在動態作用域中，符號的可見性取決於程式的執行過程，而不是編譯時的程式結構。某些語言（如Lisp）使用動態作用域。在這種情況下，符號表需要支持動態的作用域查找。

#### 4. 局部符號表與全局符號表

編譯器通常需要處理兩種符號表：**局部符號表**和**全局符號表**。

- **局部符號表**：局部符號表用於儲存特定作用域內的符號。例如，函數內部的局部變量會存儲在局部符號表中。當進入新的作用域時，編譯器會創建新的局部符號表。

- **全局符號表**：全局符號表用於儲存全局作用域中的符號，例如全局變量和函數。全局符號表通常在程式的最外層作用域中創建並保持整個編譯過程中的一致性。

編譯器會根據不同的作用域管理策略來設計符號表。當進入新的作用域時，編譯器會創建一個新的局部符號表，並在離開該作用域時銷毀局部符號表。在嵌套作用域的情況下，編譯器可能需要在查詢符號時從當前作用域的符號表查詢，並向外層作用域進行查找。

#### 5. 符號表的查詢與結構

符號表的查詢操作通常基於符號名稱（如變量名、函數名等）進行。為了提高查詢效率，編譯器會根據具體的需求選擇合適的數據結構來存儲符號。常見的查詢策略包括：

- **直接查詢**：對於簡單的符號表結構（如哈希表），查詢操作可以在常數時間內完成。編譯器可以快速查找符號的屬性。

- **範圍查詢**：當編譯器需要查詢特定範圍（如局部作用域和全局作用域）中的符號時，通常會使用樹狀結構來實現範圍查詢。例如，使用平衡樹來存儲符號，允許範圍查詢和有序遍歷。

#### 6. 符號表的更新與刪除

符號表的更新通常在編譯器的語法分析或語義分析階段進行。在變量聲明、函數定義或類型推導時，編譯器會將新的符號插入符號表。在符號的作用域結束時（例如在函數返回時或變量超出作用域時），編譯器會從符號表中刪除不再需要的符號。

符號表的設計需要確保符號的插入、更新和刪除操作不會影響編譯器的性能，並且能夠正確處理多層嵌套作用域的符號。

#### 7. 小結

符號表在編譯器的語義分析階段扮演著至關重要的角色，它用來存儲程式中的符號資訊並支持查詢、插入、更新和刪除操作。符號表的設計和實現需考慮查詢效率、作用域管理和符號的生命周期。通過精心設計符號表，編譯器能夠高效地處理程式的語義檢查，並在後續的代碼生成和優化過程中提供必要的符號資訊。