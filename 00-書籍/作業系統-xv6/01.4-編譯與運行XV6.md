### 1.4 編譯與運行 XV6

在本節中，我們將介紹如何編譯和運行 `xv6-riscv`。編譯過程將包含構建內核映像和運行 `xv6` 操作系統，並在 QEMU 模擬器中運行。這些步驟將幫助您理解 `xv6` 的內部結構並啟動操作系統。

#### 1.4.1 編譯 XV6-RISCV

在設置好開發環境並克隆好 `xv6-riscv` 的源碼後，您可以開始編譯過程。編譯過程會將源代碼轉換為適合於 RISC-V 硬體架構的可執行映像。

1. **導航到源碼目錄**：
   首先，請進入您已經克隆下來的 `xv6-riscv` 目錄：
   ```bash
   cd xv6-riscv
   ```

2. **編譯內核**：
   使用 `make` 命令進行編譯。這會啟動自動化編譯過程，將 C 語言源代碼編譯成適合於 RISC-V 架構的二進制文件。請執行以下命令：
   ```bash
   make
   ```
   `make` 會根據 `Makefile` 中的設置編譯所有源代碼，並生成一個名為 `xv6-riscv` 的可執行映像文件。

3. **檢查編譯過程**：
   編譯過程中，您會看到許多源代碼被編譯成目標文件，然後鏈接成最終的可執行映像。在編譯成功後，您應該能夠在目錄中看到 `xv6-riscv` 可執行文件：
   ```bash
   ls
   ```

   您應該看到類似於以下的文件：
   ```
   xv6-riscv
   ```

#### 1.4.2 運行 XV6-RISCV

編譯完成後，您可以使用 QEMU 模擬器來運行 `xv6-riscv`。QEMU 會模擬一個 RISC-V 虛擬機，並運行已編譯的 `xv6-riscv` 操作系統。

1. **運行 `xv6-riscv`**：
   使用以下命令來啟動 QEMU 模擬器並運行 `xv6-riscv` 內核：
   ```bash
   make qemu
   ```

   該命令會啟動 QEMU，並載入 `xv6-riscv` 操作系統的映像。在此過程中，QEMU 模擬器會顯示出 `xv6` 的啟動過程，並將控制權交給 `xv6` 操作系統。

   啟動後，您應該看到如下輸出：
   ```
   xv6 starting...
   ```

2. **交互式 Shell**：
   當 `xv6` 成功啟動時，您會看到一個命令行界面，這是 `xv6` 提供的基本 Shell。您可以輸入命令來與操作系統進行交互。

   例如，您可以使用以下命令來顯示系統中的文件：
   ```
   $ ls
   ```

   您可以輸入一些簡單的 Shell 命令來操作系統，這樣可以幫助您了解如何在 `xv6` 中運行進程和管理檔案系統。

3. **關閉 QEMU**：
   當您完成對 `xv6` 的操作後，您可以退出 `xv6`，並關閉 QEMU 模擬器。要退出，您可以使用 `Ctrl+C` 或輸入 `halt` 命令：
   ```
   $ halt
   ```

   這會終止 `xv6` 的運行並退出 QEMU 模擬器。

#### 1.4.3 常見錯誤與排錯

在編譯和運行過程中，您可能會遇到一些常見的錯誤。以下是一些常見問題及其解決方案：

1. **編譯錯誤：未找到 RISC-V 工具鏈**
   - 確保您已經正確安裝並配置了 RISC-V 工具鏈。如果工具鏈未正確安裝，您將無法編譯代碼。請確保安裝了 `gcc-riscv64-linux-gnu`，並在 `Makefile` 中設置了正確的工具鏈路徑。

2. **QEMU 問題：無法啟動模擬器**
   - 如果 QEMU 無法啟動，請檢查您是否已安裝支持 RISC-V 的 QEMU 版本。可以通過以下命令檢查 QEMU 版本：
     ```bash
     qemu-system-riscv64 --version
     ```

3. **操作系統無法啟動或崩潰**
   - 如果在啟動過程中遇到崩潰或異常，請查看 QEMU 終端中的錯誤訊息，這些訊息通常會提供有關崩潰原因的線索。您也可以在代碼中加入調試輸出來追蹤問題所在。

#### 小結

通過本節介紹的步驟，您可以順利編譯並運行 `xv6-riscv`。使用 QEMU 模擬器運行 `xv6` 使您能夠在虛擬環境中實驗操作系統功能，這對學習操作系統設計和內部實現非常有幫助。接下來，您可以進一步探索 `xv6` 的各個組件，理解其如何運作並開始進行修改與擴展。