### 12.1 即時作業系統 (RTOS)

即時作業系統（Real-Time Operating System, RTOS）是設計來滿足特定時間限制或「即時性要求」的操作系統。與傳統的作業系統相比，RTOS 需要能夠保證程式在特定的時間內完成，無論是計算任務還是處理外部事件。這種即時性要求使得 RTOS 被廣泛應用於那些對時間敏感的領域，如嵌入式系統、汽車電子、航天、醫療設備等。

#### 1. 即時作業系統的特點

即時作業系統具有以下幾個主要特點：

- **即時性（Real-Time Behavior）**：
  RTOS 能夠在確定的時間範圍內響應外部事件。這些系統必須保證最壞情況下的響應時間不會超過預定的限制。
  
- **多任務處理**：
  支援多個任務或進程的並行執行。RTOS 通常會基於優先級來決定哪些任務會被執行，並確保高優先級任務能夠及時執行。

- **優先級排程**：
  RTOS 通常會根據每個任務的優先級來進行排程。高優先級的任務會比低優先級的任務優先執行，並且 RTOS 會確保高優先級的任務在最短的時間內完成。

- **時間控制**：
  許多即時作業系統提供高精度的定時器，能夠精確控制任務執行的時機和頻率，這對於某些應用至關重要。

- **可預測性**：
  RTOS 系統的性能通常具有高度可預測性，這對於那些對延遲要求極為苛刻的應用至關重要。

#### 2. 即時作業系統的分類

即時作業系統可以根據其實時性的要求來分為兩類：

- **硬即時系統（Hard Real-Time System）**：
  在硬即時系統中，任何延遲都會造成災難性的後果。這類系統必須在預定的時間內完成任務，否則可能會導致嚴重錯誤或設備損壞。例如，航空航天系統、醫療設備中的即時控制系統。

- **軟即時系統（Soft Real-Time System）**：
  在軟即時系統中，任務可能會有延遲，但這些延遲並不會引發致命後果。這類系統通常是對時間敏感但容許一些延遲的應用場景。例如，影像處理、音頻編解碼等。

#### 3. RTOS的內部結構

RTOS 的內部結構一般包含以下核心組件：

- **內核（Kernel）**：
  內核負責系統的核心功能，包括任務管理、記憶體管理、I/O 操作、排程和中斷處理等。RTOS 的內核通常設計得極為簡潔且高效，以滿足即時性要求。

- **排程器（Scheduler）**：
  排程器根據任務的優先級和時間要求來安排任務的執行。RTOS 使用的排程算法通常是基於優先級的排程或循環排程。

- **中斷處理（Interrupt Handling）**：
  由於即時作業系統常常需要即時響應外部事件，因此有效的中斷處理是 RTOS 的關鍵功能。RTOS 通常會有較低的中斷延遲，以便及時處理來自外部硬體的請求。

- **同步機制（Synchronization Mechanisms）**：
  由於多任務並行執行，RTOS 需要提供適當的同步機制來避免競爭條件。常見的同步機制包括信號量（Semaphore）、互斥鎖（Mutex）和事件旗標（Event Flag）。

- **定時器（Timers）**：
  RTOS 需要提供高精度的定時器來控制任務的執行時間。這些定時器可以用來設置延遲、定期執行任務，或者計時。

#### 4. RTOS的範例

有許多現成的 RTOS 系統被用於嵌入式領域。以下是一些知名的 RTOS 範例：

- **FreeRTOS**：
  FreeRTOS 是一個開源的即時作業系統，設計簡單、輕便，並且支援多種硬體平台。它提供了多種排程策略和同步機制，非常適合嵌入式應用。

- **RTEMS（Real-Time Executive for Multiprocessor Systems）**：
  RTEMS 是一個實時操作系統，支援多處理器系統。它具有高效的排程、內存管理和多任務處理功能，並已被廣泛應用於航空航天和軍事領域。

- **VxWorks**：
  VxWorks 是 Wind River 公司開發的商業化 RTOS，廣泛應用於嵌入式領域，如汽車、航天、工業控制等。VxWorks 提供高可靠性、可擴展性和即時性，並支援各種硬體平台。

#### 5. Linux 與 RTOS 的區別

雖然 Linux 是一個功能強大的作業系統，但它並不完全滿足即時性要求。儘管 Linux 可以使用一些即時擴展（如 PREEMPT-RT）來改善即時性，但它仍然不是一個嚴格的即時作業系統。RTOS 和 Linux 之間的主要區別在於：

- **即時性要求**：RTOS 具有保證的即時性，而 Linux 主要是為一般計算用途設計，雖然可以通過擴展實現某些即時性特徵，但其主要用途並非即時處理。
- **排程策略**：RTOS 的排程算法通常是基於優先級的確定性排程，而 Linux 更多的是基於時間片的輪轉排程。
- **資源管理**：RTOS 的資源管理更加簡潔，通常會優化為最小化延遲，而 Linux 系統則包含大量的通用功能，這可能影響其即時性表現。

#### 6. RTOS 範例程式碼

以下是使用 **FreeRTOS** 在 **RISC-V 64** 架構下實作一個簡單的任務，並展示如何設定一個周期性任務。

```c
#include "FreeRTOS.h"
#include "task.h"
#include <stdio.h>

void vTask1(void *pvParameters) {
    while (1) {
        printf("Task 1 is running\n");
        vTaskDelay(pdMS_TO_TICKS(1000)); // 1 second delay
    }
}

void vTask2(void *pvParameters) {
    while (1) {
        printf("Task 2 is running\n");
        vTaskDelay(pdMS_TO_TICKS(500)); // 0.5 second delay
    }
}

int main(void) {
    // 初始化 FreeRTOS 系統
    xTaskCreate(vTask1, "Task1", 128, NULL, 1, NULL);
    xTaskCreate(vTask2, "Task2", 128, NULL, 1, NULL);

    // 啟動 FreeRTOS 調度器
    vTaskStartScheduler();

    // 如果調度器啟動失敗，進入無窮迴圈
    for (;;);
    return 0;
}
```

#### 7. 結論

即時作業系統（RTOS）對於嵌入式系統和時間敏感的應用場景至關重要。透過高效的排程和中斷處理機制，RTOS 能夠確保在特定的時間範圍內完成任務。無論是在航天、醫療還是車載系統中，RTOS 都扮演著重要的角色。隨著技術的發展，RTOS 會繼續向著更高效、更靈活的方向發展，並進一步與現代硬體架構（如 RISC-V 64 位）和現代開發框架（如 FreeRTOS）相結合，為各種應用提供高效能的即時性支援。