### 9.3 記憶體虛擬化

記憶體虛擬化（Memory Virtualization）是虛擬化技術的核心部分之一，通過將物理記憶體映射到虛擬記憶體，使每個應用程序都可以認為它擁有一塊獨立且連續的記憶體空間。實際上，虛擬機會共享物理記憶體，並且虛擬記憶體的分配和管理由虛擬機監控程式（Hypervisor）來處理。

記憶體虛擬化使得每個虛擬機能夠在自己的虛擬記憶體空間內運行，不會受到其他虛擬機的干擾。虛擬記憶體管理系統會將虛擬地址映射到物理地址，並可能使用技術如頁表、內存映射（memory-mapped IO）等來實現這種映射。

#### **虛擬記憶體基本概念**

1. **虛擬地址與物理地址**：
   虛擬記憶體技術的關鍵在於使用虛擬地址而不是物理地址。每個進程或虛擬機都有自己的虛擬地址空間，這使得每個虛擬機或進程認為它有自己的獨立內存。實際上，這些虛擬地址會被映射到物理內存中的不同位置。

2. **頁表（Page Table）**：
   頁表是記憶體虛擬化的核心結構，它將虛擬地址映射到物理地址。在多層次的頁表系統中，虛擬地址被劃分為多個部分，並通過頁表層次結構來確定最終的物理地址。這一過程由記憶體管理單元（MMU）完成。

   - 在 64 位的 RISC-V 系統中，常見的頁表結構是 **SV39**，它使用三層頁表結構來支持 39 位虛擬地址。

3. **MMU（Memory Management Unit）**：
   記憶體管理單元（MMU）是硬體組件，負責將虛擬地址轉換為物理地址。MMU 通過查詢頁表來完成這一轉換，它還可以處理頁面錯誤（Page Fault），並通知操作系統加載或更新頁表。

#### **記憶體虛擬化的過程**

1. **頁表映射**：
   每個虛擬機或進程都有一個單獨的頁表，虛擬地址被劃分為多個部分，每一部分對應頁表中的不同層次。MMU 查詢這些層次並確定虛擬地址所對應的物理地址。例如，SV39 會將虛擬地址分為 9 位、9 位、9 位和 12 位，並查詢三層頁表。

2. **多級頁表**：
   在多層次頁表的系統中，虛擬地址被分為多個區段，每個區段代表頁表的不同層級。以 SV39 為例，虛擬地址被分為四個部分：
   - 第一層（VPN[2]）: 用於查詢根頁表。
   - 第二層（VPN[1]）: 用於查詢中間頁表。
   - 第三層（VPN[0]）: 用於查詢最終的頁表條目。
   - 偏移量（offset）: 指向具體的物理內存位置。

   這些頁表層次使得虛擬地址空間可以被映射到物理地址空間，並且能夠實現有效的記憶體隔離。

3. **內存管理與分頁（Paging）**：
   在記憶體虛擬化中，操作系統會將記憶體劃分為固定大小的頁（通常為 4KB）。這些頁將根據需要進行映射，並且當虛擬機或進程需要訪問某些內存頁時，MMU 會根據頁表將虛擬地址轉換為物理地址。

4. **頁面錯誤處理（Page Fault Handling）**：
   當虛擬機或進程訪問未映射或無效的虛擬地址時，MMU 會觸發頁面錯誤，操作系統或虛擬機監控程式會處理這種錯誤，並將需要的頁面加載到物理記憶體中。

#### **虛擬化記憶體的實現**

1. **虛擬機監控程式的角色**：
   在虛擬化環境中，虛擬機監控程式（Hypervisor）負責管理虛擬機的記憶體資源，並確保虛擬機之間的記憶體隔離。它會為每個虛擬機設置獨立的頁表，並且對虛擬機的內存頁進行分配、映射和回收。

2. **嵌套頁表**：
   在支持硬體虛擬化的系統中，虛擬機監控程式可能需要進行兩層頁表映射：一層是虛擬機內部的虛擬地址到物理地址的映射，另一層是虛擬機的虛擬地址到宿主機物理地址的映射。這種技術稱為 **嵌套頁表（Nested Paging）**，它依賴於處理器提供的硬體支持，如 Intel 的 EPT（Extended Page Tables）和 AMD 的 NPT（Nested Page Tables）。

3. **RISC-V 虛擬化支持**：
   在 RISC-V 64 位系統中，SV39 設計提供了虛擬地址到物理地址的多層次頁表支持。RISC-V 處理器的虛擬化擴展可以支援嵌套頁表技術，並有效管理虛擬記憶體的映射。虛擬機監控程式可以利用 SV39 支援來為虛擬機分配內存頁並處理虛擬地址到物理地址的映射。

---

### **Linux 中的記憶體虛擬化**

在 Linux 環境中，記憶體虛擬化的實現通常通過 **KVM**（Kernel-based Virtual Machine）來處理。KVM 使用硬體虛擬化技術（如 Intel VT-x、AMD-V 或 RISC-V 的虛擬化擴展）來實現虛擬機的內存隔離和映射。

1. **啟動虛擬機**：
   當創建並啟動虛擬機時，KVM 會設置頁表並配置虛擬機的虛擬內存。虛擬機的內存是隔離的，它們只能訪問被分配給它們的虛擬地址空間。

2. **內存映射**：
   使用 `mmap` 系統呼叫，虛擬機可以要求分配一塊內存區域，這些內存區域將被映射到虛擬機的虛擬地址空間。KVM 和虛擬機監控程式負責將這些虛擬地址映射到物理內存。

   ```c
   void *virtual_memory = mmap(NULL, size, PROT_READ | PROT_WRITE,
                                MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
   ```

3. **RISC-V 64 中的頁表配置**：
   在 RISC-V 處理器上，虛擬機監控程式會配置 SV39 頁表來將虛擬地址映射到物理地址。在啟動虛擬機時，會創建與每個虛擬機相對應的頁表，並將其設置為 RISC-V 處理器的當前頁表。

---

記憶體虛擬化是虛擬化技術的核心部分，通過虛擬地址和物理地址的映射，使得每個虛擬機可以像在物理機上運行一樣，擁有獨立的記憶體。無論是基於 x

86、ARM 還是 RISC-V 的系統，虛擬化技術都依賴於處理器提供的硬體支持來實現高效的記憶體管理。