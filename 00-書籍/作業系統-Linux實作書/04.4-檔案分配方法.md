### 4.4 檔案分配方法

檔案分配方法是指檔案如何在磁碟或其他儲存裝置上進行存儲和管理的策略。這些方法決定了檔案在磁碟上存儲的方式，以及如何有效地分配、讀取、寫入和釋放儲存空間。檔案分配方法主要有三種：**連續分配**、**鏈結分配**和**索引分配**。每種方法都有其特點、優點與缺點，根據應用場景的不同，選擇合適的分配方法至關重要。

#### 1. 連續分配（Contiguous Allocation）

在連續分配方法中，檔案的所有資料塊在磁碟上是連續儲存的。當創建一個檔案時，系統會為其分配一段連續的空間，並將檔案資料寫入該區域。這樣，檔案的資料就可以直接在磁碟上以連續的區塊儲存。

**優點：**
- 存取速度快，因為檔案的資料是連續儲存的，可以一次性讀取或寫入多個塊。
- 頭部定位時間較短，磁碟讀寫頭需要的運動距離小。

**缺點：**
- 容易產生碎片，隨著檔案的創建和刪除，空間可能會變得不連續，無法有效利用。
- 當檔案大小變動時，需要重新分配空間，這可能會導致檔案的移動和修改。
- 預測檔案的最大大小比較困難，可能會浪費存儲空間。

**範例（C語言）**：

假設在 C 語言中，使用 `fopen()` 打開檔案，並假設檔案系統使用連續分配方法來儲存檔案。當檔案被創建時，作業系統會為檔案分配一個連續的存儲區塊：

```c
FILE *file = fopen("example.txt", "w");
if (file != NULL) {
    fprintf(file, "Hello, world!\n");
    fclose(file);
}
```

這段程式碼會將資料寫入一個連續的磁碟區域。

#### 2. 鏈結分配（Linked Allocation）

鏈結分配方法中，每個檔案的資料塊不必連續儲存，而是將每個資料塊鏈接到下一個資料塊的位置。這些資料塊以鏈表的形式組織，每個資料塊包含一個指向下一個資料塊的指標，直到檔案結尾。

**優點：**
- 無需預先知道檔案大小，可以根據需要隨時擴展。
- 可以有效地利用磁碟上的空間，減少磁碟碎片。
- 對於動態擴展的檔案來說，非常適合。

**缺點：**
- 存取速度較慢，因為每次讀取資料塊時，都需要透過指標查找下一個塊的位置，這會增加磁碟存取的延遲。
- 檔案操作時需要額外的空間來存儲指標，增加了磁碟的存儲開銷。
- 需要額外的處理來維護指標鏈表，增加了系統開銷。

**範例（C語言）**：

假設在鏈結分配方法下，當我們向檔案寫入資料時，檔案系統會自動將資料分配到非連續的區塊，並用指標鏈接這些區塊：

```c
FILE *file = fopen("example.txt", "w");
if (file != NULL) {
    fprintf(file, "This is a file with linked allocation.");
    fclose(file);
}
```

在這裡，檔案的資料塊可能會分散在磁碟上，而操作系統會使用指標鏈接這些資料塊。

#### 3. 索引分配（Indexed Allocation）

在索引分配方法中，檔案的資料塊仍然可以不連續地分佈在磁碟上，但每個檔案會有一個索引區塊。該索引區塊包含檔案所有資料塊的指標，這些指標指向檔案資料的實際儲存位置。

每個檔案都有一個索引塊，這個索引塊可能儲存在磁碟上，並且它指向檔案的每個資料塊的具體位置。這樣，檔案操作系統可以根據索引區塊來讀取或寫入檔案，而不必遍歷整個資料區域。

**優點：**
- 可以靈活地分配磁碟空間，避免了碎片化的問題。
- 檔案資料塊可以隨機存取，不必按順序查找。
- 讀取性能較好，因為磁碟存取可以根據索引直接定位。

**缺點：**
- 索引區塊的大小固定，當檔案過大時，可能會需要額外的索引區塊。
- 必須管理額外的索引區塊，這會佔用額外的磁碟空間。
- 索引區塊的大小可能限制了檔案的最大大小，尤其是在簡單檔案系統中。

**範例（C語言）**：

假設檔案系統使用索引分配方法，C 語言中的檔案操作依然使用 `fopen()` 和 `fwrite()` 等函數，但在底層，檔案系統會維護一個索引表來指向檔案資料塊。

```c
FILE *file = fopen("example.txt", "w");
if (file != NULL) {
    fprintf(file, "This is a file with indexed allocation.");
    fclose(file);
}
```

在這種情況下，檔案資料並不需要連續存儲，系統會在內部維護索引表來查找檔案的每個資料塊。

#### 4. 檔案分配方法的比較

| 特性               | 連續分配                   | 鏈結分配                     | 索引分配                       |
|--------------------|----------------------------|------------------------------|--------------------------------|
| 儲存空間利用效率   | 低，可能會產生碎片         | 高，可以有效利用空間         | 高，可以靈活分配空間           |
| 訪問速度           | 快，因為資料是連續的       | 慢，需要遍歷指標             | 快，可以隨機訪問資料塊         |
| 擴展性             | 差，預先需要確定檔案大小   | 好，可以隨時擴展             | 好，通過索引可以隨時增長檔案   |
| 實現複雜度         | 簡單，容易實現             | 複雜，涉及指標管理           | 複雜，涉及索引管理             |

#### 5. Linux 檔案系統中的檔案分配

在 Linux 中，最常見的檔案系統是 ext4，它使用了一種混合型的方法來分配檔案。ext4 使用了類似於索引分配的機制來進行檔案資料塊的分配，並且還具有日誌功能來保證系統的可靠性。它利用 `inode` 結構來存儲檔案的索引資料，包括檔案的元資料和指向檔案資料的指標。

例如，可以使用 `ls -i` 命令來查看檔案的 inode 編號，而檔案的實際資料則存儲在資料塊中。`ext4` 系統根據 inode 記錄檔案資料塊的位置。

#### 結論

檔案分配方法在作業系統中起著至關重要的作用，直接影響磁碟的存儲效率和檔案存取的性能。選擇合適的檔案分配方法，能夠有效提升檔案系統的效能和穩定性。在實際應用中，不同的檔案系統會根據需求選擇適當的分配策略，以適應不同的使用場景。