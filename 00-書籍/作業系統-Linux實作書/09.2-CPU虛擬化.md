### 9.2 CPU 虛擬化

CPU 虛擬化（CPU Virtualization）是虛擬化技術的一個關鍵部分，允許多個虛擬機共享物理 CPU 資源。每個虛擬機看起來擁有自己的獨立 CPU，並且可以像運行在真實硬體上一樣執行指令。CPU 虛擬化的實現依賴於硬體支持以及虛擬機監控程式（Hypervisor）的協同工作。

CPU 虛擬化的基本目的是將物理處理器資源劃分並分配給多個虛擬機，從而使每個虛擬機擁有獨立的處理環境，並且能夠高效地利用底層的物理處理器。

#### **虛擬化模式**

現代的處理器（包括 Intel 和 AMD 處理器）提供對虛擬化的硬體支持，通常通過兩個或更多模式來實現：

1. **用戶模式（User Mode）**：處理器運行應用程序和用戶空間程式。這些程式不能直接訪問物理硬體，而是通過操作系統提供的系統呼叫來與硬體交互。
  
2. **核心模式（Kernel Mode）**：處理器運行操作系統內核代碼，能夠訪問硬體和控制整個系統的資源。

3. **虛擬化模式（Virtual Machine Mode）**（在支持虛擬化的處理器上）：此模式是為虛擬機監控程式提供支持，虛擬機監控程式會在此模式下運行，管理多個虛擬機的 CPU 資源。虛擬機可以在虛擬化模式下運行自己的操作系統，並像在物理機上一樣執行應用程式。

#### **硬體虛擬化技術**

現代處理器，特別是基於 x86 和 RISC-V 架構的處理器，通常提供以下硬體虛擬化支持來加速虛擬化過程：

1. **Intel VT-x（Intel Virtualization Technology）**：這是 Intel 提供的一種硬體虛擬化技術，允許處理器在虛擬機監控程式和虛擬機之間切換，而不需要依賴操作系統的中斷機制。VT-x 為虛擬化提供了專門的指令集和功能，支持全虛擬化（Full Virtualization）。

2. **AMD-V（AMD Virtualization）**：這是 AMD 提供的虛擬化技術，功能與 Intel 的 VT-x 類似，並且也提供了對虛擬機監控程式的硬體支持。AMD-V 支援虛擬化擴展，如虛擬化指令集、訪問控制和虛擬化頁表等。

3. **RISC-V 虛擬化擴展（RISC-V Virtualization Extension）**：RISC-V 處理器也開始支持虛擬化。RISC-V 64 位架構中的虛擬化擴展（如 SV32, SV39, 和 SV48）使得 RISC-V 可以有效地實現虛擬化，並支持將多個虛擬機運行在同一處理器上。

   - **SV39**：這是 RISC-V 64 位系統的虛擬地址管理模式，支援多層次的頁表映射，並能夠提供 39 位的虛擬地址空間，適合大規模內存映射，並可與虛擬化技術協同工作。

#### **虛擬化的實作方式**

在虛擬化系統中，CPU 虛擬化的實作可以分為以下幾個部分：

1. **虛擬機監控程式（Hypervisor）**
   - 虛擬機監控程式是實現 CPU 虛擬化的核心組件，它在虛擬化模式下運行，負責將物理 CPU 資源分配給多個虛擬機。虛擬機監控程式可以是：
     - **Type 1 Hypervisor（裸機虛擬機監控程式）**：直接運行在物理硬體上，負責管理所有的虛擬機，常見的例子有 VMware ESXi 和 Xen。
     - **Type 2 Hypervisor（宿主虛擬機監控程式）**：運行在操作系統之上，通過操作系統來管理硬體和虛擬機，常見的例子有 VMware Workstation 和 VirtualBox。

2. **虛擬處理器的調度與切換**
   - 當虛擬機需要執行計算任務時，虛擬機監控程式會將物理 CPU 時間片分配給虛擬機。這些虛擬機會通過虛擬處理器來執行指令，而虛擬處理器實際上是在物理 CPU 上運行的指令的虛擬映射。虛擬機監控程式負責在多個虛擬機之間進行上下文切換，並確保每個虛擬機都有公平的計算時間。

3. **CPU 虛擬化指令**
   - 現代處理器提供了虛擬化指令，這些指令可以讓虛擬機監控程式在處理器上啟動或停止虛擬機。這些指令包括虛擬中斷、虛擬化頁表操作等。

4. **頁表虛擬化**
   - CPU 虛擬化通常與虛擬記憶體管理結合，使用虛擬頁表來映射虛擬地址到物理地址。在虛擬機中，虛擬機監控程式會管理每個虛擬機的頁表，並確保每個虛擬機的地址空間是隔離的。現代處理器支援二級頁表（比如 Intel 的 EPT（Extended Page Tables）或 AMD 的 NPT（Nested Page Tables））來加速這個過程。

---

### **Linux 中的 CPU 虛擬化實作**

在 Linux 環境中，CPU 虛擬化通常是通過 **KVM**（Kernel-based Virtual Machine）來實現的。KVM 依賴於硬體虛擬化技術，如 Intel VT-x 或 AMD-V，並將它們集成進 Linux 核心中，使得 Linux 可以作為虛擬機監控程式來運行虛擬機。

#### **啟用 KVM 支持**

1. **檢查處理器是否支持虛擬化**：
   使用以下指令檢查處理器是否支持硬體虛擬化：
   ```bash
   egrep -c '(vmx|svm)' /proc/cpuinfo
   ```
   - 如果返回的數字大於 0，則表示處理器支持硬體虛擬化。

2. **安裝 KVM 相關軟體**：
   在 Ubuntu 上，可以使用以下命令安裝 KVM 和相關工具：
   ```bash
   sudo apt-get install qemu-kvm libvirt-bin virt-manager bridge-utils
   ```

3. **啟動和管理虛擬機**：
   使用 `virt-manager` 或 `virsh` 工具來創建和管理虛擬機。

   - **創建虛擬機**：
     ```bash
     virt-install --name=vm01 --ram=2048 --vcpus=2 --disk path=/var/lib/libvirt/images/vm01.qcow2,size=20 --os-type=linux --os-variant=ubuntu20.04 --network network=default --graphics spice --cdrom /path/to/ubuntu.iso
     ```

   - **啟動虛擬機**：
     ```bash
     virsh start vm01
     ```

---

### **RISC-V 64 虛擬化支持**

在 RISC-V 64 位架構中，虛擬化擴展（如 **SV39** 和 **S-mode**）為 CPU 虛擬化提供了基礎。這些擴展允許 RISC-V 處理器在虛擬機監控程式中運行虛擬機，並實現虛擬處理器的管理。

RISC-V 處理器利用其硬體虛擬化擴展

，通過支持多級頁表和虛擬化支持的中斷處理，能夠高效地實現虛擬機的 CPU 虛擬化。

---

CPU 虛擬化的成功實現，使得現代計算平台更加靈活和高效，並支援多租戶環境和資源分配的最大化。