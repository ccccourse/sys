### 10.3 系統監控

系統監控是指對計算機系統的各個資源進行實時監測，目的是確保系統的穩定性和高效性，並及時發現潛在的性能問題或故障。監控的範圍包括 CPU、記憶體、磁碟、網路等硬體資源，以及操作系統層面上的各種進程和服務。有效的系統監控能夠為系統管理員提供必要的指標，從而幫助他們對系統進行調整與優化。

#### **系統監控的目的與重要性**

1. **性能監控**：
   - 監控系統資源（如 CPU 使用率、記憶體使用情況、磁碟 I/O）有助於識別性能瓶頸，並提供改善系統效能的依據。

2. **故障檢測與預防**：
   - 及早發現系統異常或故障（如磁碟空間不足、內存洩漏、過高的 CPU 使用率）有助於降低系統崩潰的風險。

3. **容量規劃**：
   - 根據監控數據，預測未來資源需求，進行容量規劃，確保系統在高負載情況下也能保持穩定。

4. **合規與審計**：
   - 系統監控對於遵守合規要求（例如數據保護法）以及進行操作審計非常重要。

#### **系統監控的主要資源**

1. **CPU 資源**：
   - 監控 CPU 使用情況，如負載、使用率、上下文切換等，有助於了解處理器的運行狀況。
   - 常見指標：`CPU 使用率`、`上下文切換數量`、`負載均衡狀況`。

2. **記憶體資源**：
   - 記憶體使用情況的監控可以幫助識別內存洩漏問題或記憶體過度使用情況，避免系統崩潰。
   - 常見指標：`可用記憶體`、`已使用記憶體`、`交換區使用情況`。

3. **磁碟與 I/O 資源**：
   - 監控磁碟的讀寫速率、磁碟空間使用情況以及磁碟 I/O 等，有助於確保資料讀取與寫入的效率。
   - 常見指標：`磁碟 I/O`、`磁碟空間使用情況`、`磁碟延遲`。

4. **網路資源**：
   - 監控網路流量、網路連接、傳輸速率等指標，有助於識別網路瓶頸或網路攻擊。
   - 常見指標：`網路帶寬使用率`、`網路延遲`、`網路錯誤與丟包`。

5. **進程與服務**：
   - 監控各進程的狀態、資源佔用情況及系統服務的健康狀況，以確保所有應用程式正常運行。
   - 常見指標：`進程 CPU 使用率`、`記憶體佔用`、`服務是否正常運行`。

#### **Linux 系統監控工具**

在 Linux 系統中，有許多工具可用於進行系統監控，下面介紹幾個常見的工具：

1. **`top`**：
   - `top` 是最常用的實時系統監控工具，它顯示當前系統中各進程的 CPU 使用率、記憶體佔用等資訊，並按需更新。
   ```bash
   top
   ```

2. **`htop`**：
   - `htop` 是 `top` 的增強版本，具有更友好的界面，支持更多的交互操作，適合用來監控系統資源。
   ```bash
   htop
   ```

3. **`vmstat`**：
   - `vmstat` 用來監控虛擬記憶體、交換區、進程、磁碟 I/O 等資源的使用情況，適用於性能分析和問題診斷。
   ```bash
   vmstat 1
   ```

4. **`iostat`**：
   - `iostat` 用於監控磁碟的 I/O 性能，它顯示磁碟的讀寫速度、I/O 等待時間等。
   ```bash
   iostat -x 1
   ```

5. **`sar`**：
   - `sar` 是 Linux 系統中一個強大的監控工具，能夠收集系統的各種資源使用統計，並生成詳細的報告。
   ```bash
   sar -u 1 5
   ```

6. **`netstat`**：
   - `netstat` 用於監控網路連接狀況，顯示目前系統的網路活動情況。
   ```bash
   netstat -tuln
   ```

7. **`ps`**：
   - `ps` 命令用於顯示系統中運行的進程狀態，提供進程的詳細資訊，包括 PID、CPU 使用率、記憶體使用情況等。
   ```bash
   ps aux
   ```

8. **`dstat`**：
   - `dstat` 是一個用於顯示系統性能數據的命令行工具，支持 CPU、記憶體、磁碟、網路等多項指標的實時監控。
   ```bash
   dstat
   ```

9. **`nmon`**：
   - `nmon` 是一個強大的性能監控工具，適用於收集系統性能數據，並提供更詳細的圖形化展示。
   ```bash
   nmon
   ```

#### **C 程式範例：監控 CPU 使用率**

以下是一個使用 C 語言編寫的簡單範例，來顯示系統的 CPU 使用率。

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    FILE *fp;
    char buffer[128];

    // 執行 top 命令來獲取 CPU 使用率
    fp = popen("top -bn1 | grep 'Cpu(s)'", "r");
    if (fp == NULL) {
        perror("popen failed");
        return 1;
    }

    while (fgets(buffer, sizeof(buffer), fp) != NULL) {
        printf("%s", buffer);
    }

    fclose(fp);
    return 0;
}
```

這段程式碼通過執行 `top` 命令來獲取系統的 CPU 使用情況，並將結果輸出。`popen` 用於執行外部命令並獲取結果。

#### **Python 範例：監控系統資源使用**

在 Python 中，可以使用 `psutil` 库來進行系統監控，下面是一個簡單的 Python 範例，用來監控 CPU 和記憶體的使用情況：

```python
import psutil
import time

while True:
    # 獲取 CPU 使用率
    cpu_usage = psutil.cpu_percent(interval=1)
    # 獲取記憶體使用情況
    memory = psutil.virtual_memory()
    
    print(f"CPU Usage: {cpu_usage}%")
    print(f"Memory Usage: {memory.percent}%")
    
    # 每隔 1 秒更新一次
    time.sleep(1)
```

這段程式碼每秒鐘顯示一次系統的 CPU 使用率和記憶體使用情況。

#### **結論**

系統監控是確保系統健康運行的關鍵，通過有效的監控工具和策略，可以實時了解系統狀況，及早發現潛在問題，從而提高系統的穩定性和效能。C 語言和 Python 提供了多種方法來實現自定義的監控，並與 Linux 系統中的標準工具配合使用，實現更靈活的監控需求。