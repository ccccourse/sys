### 7.4 虛擬記憶體系統

虛擬記憶體系統是一種允許程式使用比實際物理記憶體更多內存的技術，通過將程式的邏輯記憶體與物理記憶體進行映射，提供了一個抽象層次，讓程序可以擁有比實際硬體記憶體更大的地址空間。虛擬記憶體的核心思想是將物理記憶體劃分為頁（Pages），而程序則有自己獨立的虛擬地址空間，操作系統負責將虛擬地址映射到物理記憶體的實際地址上。

虛擬記憶體技術使得程序不必將所有數據同時加載到物理記憶體中，而是根據需要將數據動態地從輔助存儲（如硬碟）讀取到物理記憶體中。這樣，系統可以運行超過物理記憶體容量的應用程式，並有效管理多任務處理，減少記憶體資源的浪費。

### 7.4.1 虛擬記憶體的基本原理

虛擬記憶體的實現基於兩個基本概念：**虛擬地址空間**和**物理地址空間**。

#### 虛擬地址空間

每個程序運行時，都會擁有一個虛擬地址空間。這個虛擬地址空間看起來像是一個連續的記憶體區域，從0到某個最大的虛擬地址。虛擬地址空間的大小通常比物理記憶體要大，這是因為它是程序可以訪問的邏輯地址範圍，而非實際的物理存儲區域。

#### 物理地址空間

物理地址空間是實際的硬體記憶體區域，也就是計算機中的RAM。物理地址空間的大小由硬體的物理記憶體容量決定，通常是固定的。虛擬記憶體系統的目標是將虛擬地址映射到物理地址，並且在此過程中有效地管理記憶體資源。

#### 地址映射

虛擬記憶體系統的核心是將虛擬地址映射到物理地址。這一過程通常是由**記憶體管理單元（MMU, Memory Management Unit）**來完成的。MMU是一個硬體設備，它的主要任務是負責將虛擬地址轉換為物理地址，並且處理由於虛擬記憶體與物理記憶體之間的地址映射而產生的各種需求。

在虛擬記憶體系統中，虛擬地址和物理地址的映射是通過**頁表（Page Table）**來實現的。頁表是一個由操作系統維護的資料結構，記錄了虛擬頁和物理頁之間的映射關係。

### 7.4.2 頁式管理

頁式管理（Paging）是一種將記憶體劃分為固定大小單位（通常為4KB）的技術。每個單位稱為一個**頁（Page）**，而物理記憶體同樣被劃分為大小相同的單位，稱為**頁框（Frame）**。虛擬地址和物理地址之間的映射就是通過這些頁和頁框來完成的。

#### 頁表與頁表項

在頁式管理中，每個程序有一個頁表，它記錄了程序的虛擬頁對應到物理頁框的映射關係。頁表通常是由操作系統管理並儲存在物理記憶體中。

頁表中的每一條目稱為**頁表項（Page Table Entry, PTE）**，每個頁表項包含以下信息：
- **頁框號（Frame Number）**：映射到該虛擬頁的物理頁框的地址。
- **有效位（Valid Bit）**：指示該頁表項是否有效，當虛擬頁未加載到物理記憶體中時，該位會被設置為無效。
- **保護位（Protection Bits）**：包括讀、寫、執行權限等，用於保護頁面不被非法訪問。
- **修改位（Dirty Bit）**：指示頁面是否已經被修改過，這有助於在頁面交換時確定是否需要將頁面寫回硬碟。

當程序訪問某個虛擬地址時，MMU會將虛擬地址分為**頁號**（Page Number）和**頁內偏移量**（Offset）。頁號用於查詢頁表，找到對應的物理頁框號，然後再將頁內偏移量加到物理頁框號上，得到最終的物理地址。

#### 缺頁中斷（Page Fault）

當程序試圖訪問的虛擬頁尚未加載到物理記憶體時，就會發生**缺頁中斷**。操作系統會根據頁表發現該虛擬頁未被加載，然後會將該頁從硬碟或其他輔助存儲設備中加載到物理記憶體中。如果物理記憶體已滿，則操作系統會選擇一個頁框將其換出，這個過程稱為**頁面置換**。

### 7.4.3 虛擬記憶體的優勢

1. **擴展內存容量**：虛擬記憶體允許程序使用超過物理記憶體的空間，這使得系統可以運行大型應用程序，或者同時運行多個程序，而不會受到物理內存限制。
2. **提高多任務處理能力**：虛擬記憶體使得每個程序擁有獨立的記憶體空間，有效防止程序間相互干擾，提高了系統的穩定性。
3. **程序獨立性**：每個程序的虛擬地址空間都是獨立的，這使得程序不需要關心其他程序的內存布局，從而簡化了程序設計。
4. **記憶體保護**：虛擬記憶體系統提供了記憶體保護機制，能防止程序非法訪問或修改其他程序的記憶體區域，增強系統的安全性。

### 7.4.4 虛擬記憶體的挑戰

儘管虛擬記憶體技術大大提高了系統的靈活性和效率，但也帶來了一些挑戰：
- **頁面置換算法的效率**：頁面置換是虛擬記憶體系統中的關鍵，如何選擇最佳的頁面置換算法以減少頁面缺失的次數，對系統性能有很大影響。
- **存取延遲**：由於虛擬記憶體系統涉及磁碟的讀取和寫入，因此可能會引入較大的存取延遲。這就是為什麼高效的快取系統在虛擬記憶體系統中扮演著重要角色。
- **物理內存的不足**：當物理內存不足以支撐運行的程式時，系統會頻繁進行頁面交換，可能會導致性能下降，這種情況被稱為**虛擬記憶體換頁抖動（Thrashing）**。

### 7.4.5 小結

虛擬記憶體技術是一個強大的工具，它使得現代計算機能夠處理超過物理記憶體容量的應用，並提供了高效的資源管理。透過頁式管理和頁面置換技術，虛擬記憶體能夠動態分配記憶體，並為程序提供獨立的記憶體空間。儘管如此，虛擬記憶體系統仍然面臨一些挑戰，特別是在高性能和大規模計算的環境中。隨著硬體技術的發展，虛擬記憶體系統將繼續演進，應對更複雜的記憶體需求。