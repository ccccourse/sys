### 11.1 內建 SHA256 電路的比特幣挖礦機

比特幣挖礦（Bitcoin mining）是一種計算密集型過程，依賴於 SHA256 演算法來計算區塊鏈中的工作量證明（Proof of Work）。在這一章中，我們將介紹如何設計一個內建 SHA256 計算電路的比特幣挖礦機，並討論其數學原理、性能優化及效能計算。

#### SHA256 演算法概述

SHA256（Secure Hash Algorithm 256-bit）是由美國國家安全局（NSA）設計的一個加密雜湊函數，生成 256 位的雜湊值。SHA256 是比特幣挖礦中核心的計算步驟，通過它可以將一個區塊的頭部信息轉換為一個固定長度的雜湊值，並確保該雜湊值符合指定的難度目標。

SHA256 的計算過程可分為以下幾個步驟：

1. **填充消息**：將原始消息進行填充，使其長度為 512 的倍數。
2. **初始化哈希值**：使用預定的 8 個常數作為初始哈希值。
3. **訊息擴展**：將消息分為 16 個 32 位字，並通過一定的變換生成 64 個 32 位字的訊息擴展。
4. **主循環**：使用一組常數和擴展的訊息字來更新哈希值。
5. **最終結果**：經過主循環計算後，8 個 32 位字的結果拼接成 256 位的雜湊值。

#### 設計原理與數學考量

SHA256 演算法的運算本質上涉及大量的邏輯運算、位移操作和加法操作。對於比特幣挖礦來說，將 SHA256 運算實現為硬體電路可以大幅提高運算速度，並有效提高比特幣挖礦的效能。

##### 1. 數學原理

SHA256 主要使用的是位操作（如與、或、異或、位移）和模加運算。以下是 SHA256 中使用的兩個主要運算：

- **位移操作**：SHA256 中常用的操作之一是對數據進行位移操作。例如，右位移操作（>>）和循環右位移操作（>>>）會根據指定位數將數字的二進位表示向右移動，這對提高隨機性和混合效果非常重要。

  假設一個 32 位數字為 \( x = 11001100110011001100110011001100_2 \)，對其進行 4 位的右位移後，會得到：

  \[
  x >> 4 = 00001100110011001100110011001100_2
  \]

  這些位移操作可以確保數據的分佈更加均勻，增強加密強度。

- **模加運算**：在 SHA256 的循環中，所有的加法都會在 32 位無符號數字範圍內進行。這意味著加法後的結果如果超過 32 位，會將超過的部分“捨棄”並進行模運算。這種處理確保了每次迭代後的數據始終保持在固定大小範圍內。

  模加運算公式為：

  \[
  (a + b) \mod 2^{32}
  \]

  這意味著當加法的結果超過 32 位時，超過的部分會自動捨去，只保留低 32 位的結果。

##### 2. 性能優化

在硬體中實現 SHA256，最重要的考慮因素是速度和能效。比特幣挖礦機需要處理大量的哈希運算，並且每秒鐘需要進行數十億次哈希運算，因此需要在硬體層面進行優化。

- **流水線設計（Pipelining）**：SHA256 計算過程包含多輪操作，並且每輪操作之間是依賴的。為了提高運算速度，可以使用流水線技術將不同的操作分為多個階段，並且在每個時鐘周期內同時處理多個數據。

- **並行處理**：將多個 SHA256 運算單元進行並行處理，能夠大幅提升計算速度。在比特幣挖礦中，通常會將多個 SHA256 單元並行運算，這樣可以在每個時鐘週期內處理更多的數據。

- **硬體加速**：SHA256 計算涉及大量的加法和邏輯操作，這些操作可以通過專用硬體來加速。例如，可以使用 FPGA（現場可編程邏輯閘陣列）或 ASIC（專用集成電路）來設計專門的 SHA256 加速單元。

#### 數學範例

假設我們有一個區塊的頭部信息 \( H_0 \)，並希望通過 SHA256 演算法計算出一個 256 位的雜湊值。在這裡，我們的任務是進行多次 SHA256 計算，並確保最終的雜湊值滿足比特幣網絡的難度目標。根據難度要求，這個雜湊值的前幾個位需要為零。

**步驟 1：消息填充**

將消息填充至 512 位的倍數，並添加額外的 64 位來表示消息長度。

**步驟 2：初始化哈希值**

使用以下的 8 個常數作為 SHA256 的初始哈希值：

\[
H_0 = \text{0x6a09e667}, \text{0xbb67ae85}, \text{0x3c6ef372}, \text{0xa54ff53a},
\text{0x510e527f}, \text{0x9b05688c}, \text{0x1f83d9ab}, \text{0x5be0cd19}
\]

**步驟 3：訊息擴展**

將 512 位的消息分為 16 個 32 位字，並將它們擴展為 64 個字。

**步驟 4：主循環**

進行 64 輪的運算，每一輪都使用如下公式更新哈希值：

\[
T_1 = h + Σ_1(e) + Ch(e,f,g) + K_t + W_t
\]
\[
T_2 = Σ_0(a) + Maj(a,b,c)
\]

其中，\( Σ \) 和 \( Ch \) 是預定的位運算，\( K_t \) 是第 \( t \) 輪的常數，\( W_t \) 是訊息擴展生成的字。

**步驟 5：最終結果**

完成所有運算後，得到最終的 256 位雜湊值，這就是 SHA256 計算的結果。

#### 結論

通過內建 SHA256 電路的設計，比特幣挖礦機可以大幅提高哈希計算的效率。這樣的硬體加速能夠在每秒鐘內進行數十億次的 SHA256 計算，有效加快比特幣區塊的處理速度，並提升挖礦效能。隨著硬體技術的不斷發展，專用的 ASIC 芯片在比特幣挖礦中的應用使得能效和運算速度達到了前所未有的水平。

### 內建 SHA256 電路的比特幣挖礦機：效能比較

在這一部分，我們將比較兩種情況的效能：一個是使用專用 SHA256 電路的比特幣挖礦機，另一個是使用通用處理器（如 CPU）來執行 SHA256 演算法。這樣的比較有助於了解專用硬體在處理這類高密度計算任務時的優勢。

#### 假設與條件

假設我們的比特幣挖礦工作是基於挖掘一個區塊，並且每次需要進行多次 SHA256 計算。下面是兩種情況的條件假設：

1. **專用 SHA256 電路（ASIC/FPGA）**：
   - 每個 SHA256 演算法計算的時間：\( t_{asic} = 10 \, \text{ns} \)（這是硬體加速的時間，專用硬體優化後的時間）。
   - 每秒鐘可執行的 SHA256 計算次數：\( \text{rate}_{asic} = \frac{1}{t_{asic}} = 100 \, \text{M} \)（每秒可計算 1 億次 SHA256）。

2. **通用處理器（CPU）**：
   - 每個 SHA256 演算法計算的時間：\( t_{cpu} = 10 \, \mu\text{s} \)（這是基於常規 CPU 計算的時間，假設為 10 微秒）。
   - 每秒鐘可執行的 SHA256 計算次數：\( \text{rate}_{cpu} = \frac{1}{t_{cpu}} = 100,000 \)（每秒可計算 10 萬次 SHA256）。

### 效能計算

假設我們需要進行一個挖礦操作，並且在這過程中需要處理 \( N \) 次 SHA256 計算。挖礦機需要找到一個符合難度要求的哈希值。

1. **使用專用 SHA256 電路**：
   - 假設總共需要進行 \( N = 10^{12} \) 次 SHA256 計算來解決挖礦問題（這是基於比特幣的難度等級，實際情況會根據網絡難度而變化）。
   - 所需時間：
     \[
     T_{asic} = \frac{N}{\text{rate}_{asic}} = \frac{10^{12}}{10^8} = 10^4 \, \text{秒} = 10 \, \text{小時}
     \]

2. **使用通用 CPU**：
   - 同樣的，假設需要進行 \( N = 10^{12} \) 次 SHA256 計算。
   - 所需時間：
     \[
     T_{cpu} = \frac{N}{\text{rate}_{cpu}} = \frac{10^{12}}{10^5} = 10^7 \, \text{秒} = 115.74 \, \text{天}
     \]

### 效能比較

通過上面的效能計算，我們可以清楚地看出，專用 SHA256 電路（如 ASIC 或 FPGA）在處理比特幣挖礦工作時，能夠顯著縮短所需的時間。對於一個需要 \( 10^{12} \) 次 SHA256 計算的挖礦問題，專用硬體可以在約 10 小時內完成，而通用處理器則需要大約 116 天才能完成相同的計算。

這樣的差距來自於兩個方面：

1. **計算速度**：專用硬體經過優化，專門為了運行 SHA256 演算法而設計，能夠在每個時鐘週期內執行更多的計算。相比之下，通用 CPU 需要處理各種不同的運算任務，其執行 SHA256 的效率要低得多。
   
2. **並行處理**：專用硬體通常具有多個並行運算單元，可以同時處理大量的哈希計算。CPU 雖然有多核處理器，但相對於專用電路而言，其並行處理能力仍然有限。

### 效能提升

通過使用專用 SHA256 電路，比特幣挖礦機的效能得到了極大的提升，這是因為專用硬體能夠在相同的時間內進行更多的運算。例如，專用硬體的速度比 CPU 快了大約 10,000 倍。這一效能提升使得比特幣挖礦變得更加高效，並且可以大規模部署專用設備來進行挖礦競爭。

### 能效考量

除了計算速度，能效也是比特幣挖礦過程中的一個重要因素。專用硬體在執行相同的計算任務時，通常具有更低的功耗。這是因為專用硬體可以針對特定的計算進行優化，使得每次計算所消耗的電力更少。因此，儘管專用硬體的初期投資可能較高，但長期來看，其能效帶來的節省可以抵消這些成本。

### 結論

使用內建 SHA256 電路的專用比特幣挖礦機相比於使用通用 CPU 的比特幣挖礦機，能夠大幅提高運算效率並縮短計算時間。專用硬體的計算速度更快，並且具有更高的能效，這使得比特幣挖礦在當前的競爭環境中，依賴於專用硬體來維持較高的效率和競爭力。