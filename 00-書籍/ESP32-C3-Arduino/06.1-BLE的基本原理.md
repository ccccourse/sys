### 6.1 **BLE 的基本原理**

藍牙低能耗技術（Bluetooth Low Energy，簡稱 BLE）是藍牙技術的一種變種，旨在提供低功耗的無線通信。它特別適合用於需要低功耗、短距離通信的應用，並且能夠在長時間內穩定工作。BLE 廣泛應用於物聯網（IoT）設備中，像是健康監測設備、智能家居、穿戴設備等。ESP32-C3 支援藍牙 5.0 LE，可以實現高效且低功耗的藍牙通信。

---

### 1. **BLE 的基本概念**

BLE 和傳統藍牙（Bluetooth Classic）相比，有以下主要的區別和特點：

- **低功耗：** BLE 旨在提供比傳統藍牙更低的功耗，尤其適用於那些需要長時間運行的設備，如傳感器、健康追蹤器、智能手環等。BLE 設備的電池壽命可以長達數月甚至數年，這主要得益於 BLE 的短時數據傳輸和休眠模式。
- **短距離通信：** BLE 支持的通信距離通常為 10 到 100 米，這使它非常適合需要短距離且高效能通信的應用場景。
- **點對點通信與群組通信：** BLE 支援兩種通信模式：一對一的點對點通信以及一對多的群組通信。這使得 BLE 能夠在各種不同的應用場景中進行靈活的連接和數據傳輸。

---

### 2. **BLE 的工作模式**

BLE 有兩個主要的工作模式：**廣播模式（Advertising）** 和 **連接模式（Connection）**。這些模式決定了 BLE 設備如何與其他設備進行通信。

#### 1. **廣播模式（Advertising）**
廣播模式是 BLE 設備發送數據的模式。在此模式下，設備會定期發送簡單的廣播信號，這些信號可以被其他設備接收。廣播模式通常用於不需要建立持久連接的場景，如設備發現和簡單數據交換。

- **發射範圍**：發送設備會周期性地廣播信號，範圍通常為數米到數十米。
- **無需配對**：廣播模式下不需要配對過程，其他設備可以接收到廣播信號並根據需求進行處理。

#### 2. **連接模式（Connection）**
當兩個 BLE 設備進入連接模式時，它們會進行一個配對過程，並在配對後保持長時間的通信。連接模式下，設備會進行更高效的數據傳輸。這種模式適用於需要持久連接的場景，如設備控制或數據傳輸。

- **配對與配對管理**：在連接模式下，BLE 設備會進行身份認證、加密等配對操作，並能進行更高效的數據通信。
- **持久連接**：設備之間建立連接後，兩者可以在需要時持續進行數據傳輸，並且可以在此過程中進行更精細的管理和控制。

---

### 3. **BLE 的關鍵特性**

#### 1. **數據傳輸速率**
BLE 支援的數據傳輸速率相對較低，通常為 1 Mbps 或更低，但對於大多數低功耗設備來說，這樣的速率已經足夠。BLE 5.0 引入了更高的數據傳輸速率（最高 2 Mbps），這對於某些應用有很大的提升。

#### 2. **節能模式**
BLE 設備在不進行數據傳輸時會進入睡眠模式，這樣可以有效減少功耗。當設備需要傳輸數據時，才會進入活躍狀態。這種睡眠與喚醒機制使得 BLE 設備在運行時能夠保持長時間的電池壽命。

#### 3. **多通道支持**
BLE 支援 37 至 39 個廣播通道，每個通道都具有不同的頻率。這些通道有助於避免信號干擾，並提高數據傳輸的可靠性。

---

### 4. **BLE 5.0 的新特性**

BLE 5.0 是 BLE 技術的一個重要版本，引入了許多新的功能，進一步提高了性能和可擴展性。

- **更高的數據傳輸速率：** BLE 5.0 支援最高 2 Mbps 的數據傳輸速率，比之前的版本（最大 1 Mbps）快了一倍。
- **更長的傳輸距離：** BLE 5.0 增強了廣播功能，最大傳輸距離可達 240 米（在理想環境下），這使得 BLE 更適合用於更大範圍的應用。
- **更多的廣播數據：** BLE 5.0 擴展了每次廣播時可傳送的數據量，最多可以傳送 255 字節的數據，這對於一些需要傳輸更多信息的應用非常有用。
- **增強的群組通信：** BLE 5.0 支援多設備間的同步通信，這對於智能家居和其他物聯網應用的協同工作非常重要。

---

### 5. **BLE 在 ESP32-C3 上的應用**

ESP32-C3 支援藍牙 5.0 LE，並提供豐富的開發庫（如 ESP-IDF 和 Arduino 库）來幫助開發者實現 BLE 應用。ESP32-C3 作為 BLE 伺服器或 BLE 客戶端，都能夠輕鬆地實現設備發現、數據傳輸、設備控制等功能。這使得 ESP32-C3 成為一個理想的 BLE 物聯網設備平台。

- **BLE 伺服器：** ESP32-C3 可以作為 BLE 伺服器，將其功能暴露給其他 BLE 客戶端設備，並通過 GATT（通用屬性配置文件）協議進行通信。
- **BLE 客戶端：** ESP32-C3 也可以作為 BLE 客戶端，搜索並連接到其他 BLE 設備，實現數據交互和設備控制。

---

### 6. **BLE 範例：建立一個簡單的 BLE 伺服器**

在 ESP32-C3 上實現 BLE 伺服器相對簡單。以下是一個簡單的範例程式，展示如何使用 ESP32-C3 建立一個 BLE 伺服器並暴露一個可讀取的特徵：

```cpp
#include <Arduino.h>
#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEServer.h>
#include <BLE2902.h>

// UUIDs for the service and characteristic
#define SERVICE_UUID        "12345678-1234-1234-1234-123456789abc"
#define CHARACTERISTIC_UUID "87654321-4321-4321-4321-abcdefabcdef"

BLECharacteristic *pCharacteristic;

void setup() {
  Serial.begin(115200);
  BLEDevice::init("ESP32-BLE-Server");  // 初始化 BLE 設備名稱

  // 建立 BLE 伺服器
  BLEServer *pServer = BLEDevice::createServer();

  // 建立服務
  BLEService *pService = pServer->createService(SERVICE_UUID);

  // 建立特徵
  pCharacteristic = pService->createCharacteristic(
                        CHARACTERISTIC_UUID,
                        BLECharacteristic::PROPERTY_READ |
                        BLECharacteristic::PROPERTY_NOTIFY
                    );

  pCharacteristic->setValue("Hello, BLE Client!");  // 設定特徵值

  pService->start();  // 啟動服務

  // 開啟廣播，讓其他設備可以發現該伺服器
  BLEAdvertising *pAdvertising = pServer->getAdvertising();
  pAdvertising->start();
  Serial.println("BLE Server is running...");
}

void loop() {
  // 在此處可以添加其他的處理邏輯
}
```

#### **程式說明：**
- 在 `setup()` 中，初始化 BLE 設備並創建 BLE 伺服器。
- 創建一個服務和一個特徵，並將特徵的初始值設為 `"Hello, BLE Client!"`。
- 開啟廣播，讓其他 BLE 設備能夠發現並連接到此伺服器。

---

### 7. **總結**

藍牙低能耗（BLE）是一種高效、低功耗的無線通信技術，廣泛應用於物聯網設備中。ESP32-C3 支援 BLE 5.0，提供了靈活的 BLE 開發平台，無論是用作 BLE 伺服器還是 BLE 客戶端，ESP32-C3 都能輕鬆應對各種應用場景。藍牙的低功耗特性使得它非常適合長時間運行的小型設備，從而推動了智能家居、健康監測等應用的發展。