### 8.1 **FreeRTOS 簡介與核心概念**

**FreeRTOS**（Free Real-Time Operating System）是一個開源的實時操作系統，專為嵌入式系統設計，廣泛應用於物聯網設備、微控制器和其他資源受限的嵌入式平台上。它提供了多任務處理、時間管理、同步機制等功能，使得開發者能夠在資源有限的設備上實現高效的並行運算和實時響應。

ESP32-C3 基於 FreeRTOS 提供了內建的多任務支持，這使得開發者可以輕鬆管理複雜的應用程序，並在不同的任務之間進行協調和調度。FreeRTOS 支援優先級調度、隊列、信號量、事件組等常用的同步機制，這些功能在處理多任務、實時控制和資源共享時非常有用。

---

### 1. **FreeRTOS 的核心概念**

在理解 FreeRTOS 之前，首先要了解其一些基本概念，這些概念構成了系統的運作基礎。

#### **任務（Task）**
任務是 FreeRTOS 中的基本運行單位，相當於傳統操作系統中的進程或線程。每個任務都包含了要執行的代碼，並且有自己的堆棧空間和優先級。任務會在系統中並行執行，具體執行順序由操作系統的調度器根據任務的優先級來決定。

#### **調度器（Scheduler）**
調度器負責管理和調度任務的執行。在 FreeRTOS 中，調度器是基於優先級的，即任務根據其設置的優先級被安排執行。當系統有多個任務時，調度器會選擇當前優先級最高的任務執行。當高優先級任務可執行時，調度器會立即切換到該任務。

#### **優先級（Priority）**
每個任務在 FreeRTOS 中都有一個優先級，優先級數值越小，任務的優先級越高。FreeRTOS 支援多級優先級調度，通常任務會根據其優先級進行執行。如果兩個或更多的任務具有相同的優先級，則調度器會根據時間片來進行輪換調度。

#### **隊列（Queue）**
隊列是 FreeRTOS 用來在任務之間傳遞數據的一種機制。隊列實現了先進先出（FIFO）策略，允許一個任務將數據發送到隊列中，另一個任務從隊列中讀取數據。這對於實現不同任務之間的通信非常有用。

#### **信號量（Semaphore）**
信號量是用來控制共享資源訪問的同步機制。FreeRTOS 支援兩種主要類型的信號量：
- **二元信號量（Binary Semaphore）**：用來在兩個任務之間同步或協調。
- **計數信號量（Counting Semaphore）**：用來管理多個資源的同步，通常用於限制訪問某一共享資源的最大任務數量。

#### **互斥量（Mutex）**
互斥量是信號量的一種特殊形式，專門用於保護共享資源的訪問，避免同時多個任務訪問相同的資源而導致數據不一致。FreeRTOS 中的互斥量比信號量更強大，支持優先級繼承機制，這能避免優先級反轉問題。

#### **事件組（Event Groups）**
事件組是 FreeRTOS 提供的一種機制，允許多個任務共享一個或多個事件。每個任務可以根據事件組中的標誌位來等待、檢查或設置事件。事件組對於實現複雜的任務同步和協作非常有用。

---

### 2. **FreeRTOS 的運行流程**

FreeRTOS 的運行流程主要包括以下幾個步驟：

1. **任務創建：** 開發者創建任務並設置其優先級、堆棧大小、執行函數等。每個任務都由 `xTaskCreate` 函數創建並加入調度隊列。
   
2. **調度：** 當 FreeRTOS 開始運行時，調度器會根據優先級調度各個任務的執行。調度器在任務之間進行切換，確保最高優先級的任務得到執行。

3. **任務切換：** 當一個任務的時間片用完，或者遇到更高優先級的任務時，FreeRTOS 會自動切換到其他任務。任務切換是基於搶佔式調度模型的。

4. **同步機制：** 任務之間可以通過隊列、信號量、互斥量等機制進行同步，這些同步機制有助於保證數據的安全性，避免競爭條件。

5. **任務終止：** 當任務執行完畢或不再需要時，它可以通過 `vTaskDelete` 函數被終止，並釋放相關資源。

---

### 3. **如何使用 FreeRTOS**

在 ESP32-C3 開發中，FreeRTOS 已經集成在 ESP-IDF 開發框架中。因此，開發者可以直接利用 ESP-IDF 提供的 API 來創建和管理任務。

#### **範例：創建並運行兩個任務**

這個範例展示了如何創建兩個簡單的任務，並讓它們並行執行。

```cpp
#include <Arduino.h>

void Task1(void *pvParameters) {
  while (1) {
    Serial.println("Task 1 is running");
    vTaskDelay(1000 / portTICK_PERIOD_MS);  // 延遲 1000 毫秒
  }
}

void Task2(void *pvParameters) {
  while (1) {
    Serial.println("Task 2 is running");
    vTaskDelay(1500 / portTICK_PERIOD_MS);  // 延遲 1500 毫秒
  }
}

void setup() {
  Serial.begin(115200);
  
  // 創建任務，並設置其優先級和堆棧大小
  xTaskCreate(Task1, "Task 1", 1000, NULL, 1, NULL);
  xTaskCreate(Task2, "Task 2", 1000, NULL, 2, NULL);  // Task2 的優先級較高
}

void loop() {
  // 空的 loop 函數，FreeRTOS 將管理任務的調度
}
```

#### **程式碼解釋：**
- **xTaskCreate(Task1, "Task 1", 1000, NULL, 1, NULL);**: 創建一個名為 Task1 的任務，並設置其堆棧大小為 1000 字節，優先級為 1。
- **vTaskDelay(1000 / portTICK_PERIOD_MS);**: 使任務延遲 1000 毫秒，以便釋放 CPU，讓其他任務有機會執行。

這個範例創建了兩個任務，它們會在不同的時間間隔內運行，並且在串口監視器中交替顯示消息。

---

### 4. **FreeRTOS 的優勢與挑戰**

#### **優勢：**
- **多任務管理：** FreeRTOS 提供了一個輕量級的多任務調度機制，能夠有效地管理嵌入式系統中的多個任務。
- **實時性能：** 由於 FreeRTOS 是一個實時操作系統，它可以精確地控制任務的執行時機，適合對延遲要求較高的應用。
- **小型嵌入式設備支持：** FreeRTOS 的內存開銷較小，適合用於資源有限的嵌入式設備。

#### **挑戰：**
- **學習曲線：** 雖然 FreeRTOS 提供了強大的功能，但初學者可能需要一些時間來理解任務調度、同步機制等核心概念。
- **調試困難：** 多任務系統中的調試相對困難，特別是當多個任務之間的同步出現問題時。

---

### 5. **總結**

FreeRTOS 是一個強大的實時操作系統，適用於多任務和資源受限的嵌入式設備。它提供了豐富的任務管理和同步機制，能夠有效地處理多任務並實現高效的實時控制。ESP32-C3 支援 FreeRTOS，使得開發者可以在開發 IoT 應用時充分利用其多任務處理能力。