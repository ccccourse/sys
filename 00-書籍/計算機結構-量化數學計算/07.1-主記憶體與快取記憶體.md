### 7.1 主記憶體與快取記憶體

**設計原理：**

在計算機系統中，主記憶體（RAM）和快取記憶體（Cache Memory）是兩種不同類型的存儲系統，它們各自有不同的設計原理和目標。主記憶體通常是計算機中容量最大的存儲系統，但其存取速度較慢；而快取記憶體則是介於主記憶體與CPU之間的小型、高速存儲系統，旨在提高數據訪問效率。

**1. 主記憶體（RAM）：**

主記憶體是計算機中用來儲存運行中的程序和資料的地方。其主要特點是大容量和相對較慢的存取速度。隨著現代處理器的運算速度提高，主記憶體的存取時間（通常是微秒級別）成為系統性能的瓶頸。儘管主記憶體的容量足夠大，通常有幾GB至數十GB的大小，但其速度比處理器的運算速度慢很多，這樣會造成處理器等待資料的現象，進而影響整體系統效能。

**2. 快取記憶體（Cache Memory）：**

為了解決這個瓶頸，計算機引入了快取記憶體。快取記憶體是位於處理器和主記憶體之間的小型、高速的記憶體，能夠儲存當前處理器可能需要的數據或指令。當處理器需要讀取資料時，它會首先查找快取記憶體，若資料存在（稱為“快取命中”），則直接從快取中獲得，這比從主記憶體中讀取資料要快得多。若資料不在快取中（稱為“快取未命中”），則處理器必須從主記憶體中讀取資料，並將這些資料放入快取，以便下次使用。

快取記憶體通常分為多級：L1快取（最接近CPU，速度最快）、L2快取（較大但速度較慢）、L3快取（通常在多核處理器中共享，容量最大但速度較慢）。多級快取結構使得資料的存取更加高效。

**數學模型與效能考量：**

為了分析主記憶體和快取記憶體的效能，我們通常使用“命中率”和“存取時間”來量化性能。

1. **命中率（Hit Rate）**：
   命中率是指快取記憶體中能夠找到所需數據的比例。如果快取命中率高，處理器將大多數時間從快取中讀取資料，這會顯著提高效能。

   \[
   \text{Hit Rate} = \frac{\text{Number of Cache Hits}}{\text{Total Cache Accesses}}
   \]

2. **平均存取時間（Average Access Time, AAT）**：
   平均存取時間是計算快取記憶體和主記憶體存取時間的加權平均。假設從快取讀取資料的時間為 \( T_{cache} \)，從主記憶體讀取資料的時間為 \( T_{memory} \)，並且快取命中率為 \( H \)，則平均存取時間的公式為：

   \[
   \text{AAT} = (H \times T_{cache}) + ((1 - H) \times T_{memory})
   \]

   其中，\( H \) 是快取命中率，\( T_{cache} \) 是快取的存取時間，\( T_{memory} \) 是主記憶體的存取時間。由此可見，增大快取命中率或減少主記憶體的存取時間將有效提高整體效能。

3. **快取命中率的提升：**
   提升快取命中率的一個常見方法是增加快取的容量或改善快取的組織結構。例如，從直接映射快取升級為組合快取，可以增加命中率。然而，增加快取容量會增加成本和功耗，因此必須在效能和成本之間做出平衡。

**舉例：**

假設：

- 主記憶體的存取時間 \( T_{memory} = 100 \) ns。
- 快取記憶體的存取時間 \( T_{cache} = 1 \) ns。
- 快取命中率 \( H = 0.9 \)（即90%的資料能從快取中讀取）。

我們可以計算出平均存取時間：

\[
\text{AAT} = (0.9 \times 1 \, \text{ns}) + (0.1 \times 100 \, \text{ns}) = 0.9 \, \text{ns} + 10 \, \text{ns} = 10.9 \, \text{ns}
\]

這意味著在這種配置下，平均存取時間是10.9 ns。即便主記憶體的存取時間較長，但由於高快取命中率，平均存取時間仍然保持在較低的水準。

**效能改進：**

1. **提高快取命中率：** 如果快取命中率提高到95%（即 \( H = 0.95 \)），則：

\[
\text{AAT} = (0.95 \times 1 \, \text{ns}) + (0.05 \times 100 \, \text{ns}) = 0.95 \, \text{ns} + 5 \, \text{ns} = 5.95 \, \text{ns}
\]

此時，平均存取時間下降到5.95 ns，顯著提高了效能。

2. **降低主記憶體存取時間：** 如果主記憶體的存取時間降低到50 ns（即 \( T_{memory} = 50 \) ns），則：

\[
\text{AAT} = (0.9 \times 1 \, \text{ns}) + (0.1 \times 50 \, \text{ns}) = 0.9 \, \text{ns} + 5 \, \text{ns} = 5.9 \, \text{ns}
\]

此時，平均存取時間再次下降，達到5.9 ns。

**結論：**

透過增加快取命中率或減少主記憶體存取時間，可以顯著提升系統的效能。快取記憶體作為主記憶體和CPU之間的橋樑，在提高資料存取速度方面扮演著關鍵角色。計算機設計師需要在成本、功耗和效能之間做出權衡，選擇適合的快取配置和主記憶體設計。