### 性能分析工具：Nsight Compute 與 Nsight Systems  

NVIDIA 提供的 **Nsight Compute** 和 **Nsight Systems** 是專業的 GPU 性能分析工具，分別專注於微觀的內核（Kernel）執行效能與宏觀的系統交互性能分析。這兩者結合使用，可以全面提升 CUDA 應用的性能。  

---

#### **1. Nsight Compute: 微觀內核性能分析**  

Nsight Compute 是一款專注於 GPU 核心函數（Kernel）執行的性能分析工具，適用於分析內核的計算效率、記憶體訪問模式和硬體利用率等問題。

##### **1.1 核心功能**  
- **計算效率分析**：查看核心執行單元（SM）的利用率。  
- **記憶體訪問模式**：檢測全域記憶體與共享記憶體的訪問模式與效率。  
- **指標報告**：提供詳細的執行指標，如佔用率、延遲和吞吐量。  
- **性能瓶頸建議**：基於指標提供優化建議。  

##### **1.2 使用流程**  

1. **啟動 Nsight Compute**：  
   使用命令行分析 CUDA 應用：  
   ```bash
   ncu ./vector_add
   ```  

2. **關鍵指標解讀**：  
   - **Compute Utilization（計算利用率）**：SM 的忙碌程度。  
   - **Memory Utilization（記憶體利用率）**：記憶體帶寬的使用情況。  
   - **Warp Efficiency（Warp 效率）**：執行單元中活躍線程的比例。  

3. **分析報告**：  
   - 簡單任務：CLI 即時輸出報告。  
   - 複雜任務：生成 `.ncu-rep` 檔案，使用圖形化界面查看詳細數據。  

4. **圖形化界面**：  
   打開 Nsight Compute GUI，載入報告檔案進行深入分析。  

##### **1.3 常見優化方向**  
- 增加 SM 的利用率（提高佔用率和指令並行度）。  
- 優化記憶體訪問模式（減少全域記憶體延遲，增加共享記憶體使用）。  
- 減少分支分歧（warp divergence）。  

---

#### **2. Nsight Systems: 宏觀系統性能分析**  

Nsight Systems 是一款適合從系統層面分析 GPU 應用性能的工具，專注於主機與裝置交互的時間線分析，適用於查找 CPU 與 GPU 的同步瓶頸。  

##### **2.1 核心功能**  
- **全局系統時間線**：展示 CPU 和 GPU 的任務調度與執行。  
- **API 分析**：詳細記錄 CUDA API 的調用次數與執行時間。  
- **數據傳輸分析**：檢測主機與裝置間數據傳輸的頻率與延遲。  
- **同步與延遲分析**：幫助發現任務調度中的瓶頸與未使用的 GPU 時間段。  

##### **2.2 使用流程**  

1. **啟動 Nsight Systems**：  
   執行以下命令記錄執行過程：  
   ```bash
   nsys profile ./vector_add
   ```  

2. **查看報告**：  
   - **CLI 報告**：命令行顯示簡要性能數據。  
   - **生成報告檔案**：產生 `.nsys-rep` 檔案，用於圖形化分析：  
     ```bash
     nsys-ui
     ```  

3. **關鍵視圖**：  
   - **Timeline 視圖**：展示 GPU 與 CPU 的執行時間和互動模式。  
   - **CUDA API 視圖**：顯示 CUDA 函數的調用時間、次數與影響。  
   - **數據傳輸視圖**：幫助分析主機與裝置之間的數據瓶頸。  

##### **2.3 常見優化方向**  
- 減少主機與裝置間數據傳輸的頻率或批量傳輸數據。  
- 平衡 CPU 和 GPU 工作負載，減少同步等待時間。  
- 優化 API 調用次數，合併小型任務以提升效率。  

---

#### **3. Nsight Compute 與 Nsight Systems 的結合使用**  

| **工具**            | **分析層級**              | **適用場景**                              |
|---------------------|--------------------------|-------------------------------------------|
| Nsight Compute      | 微觀層級（內核函數）      | 分析 GPU 內部計算效率與記憶體性能問題。    |
| Nsight Systems      | 宏觀層級（整體應用程式）   | 發現 CPU-GPU 同步瓶頸與數據傳輸問題。      |

通過先用 Nsight Systems 檢測整體瓶頸，再深入 Nsight Compute 優化內核性能，可以快速找到並解決 CUDA 程式中的性能問題。  

---

#### **4. 最佳實踐建議**  

1. **設定基準性能**：在每次優化前記錄原始執行時間與性能指標，對比優化後的數據。  
2. **逐步優化**：從宏觀到微觀逐步排查，確保每次調整都帶來性能提升。  
3. **硬體知識**：熟悉 GPU 硬體架構（如記憶體層次、SM 工作原理）能更有效進行性能分析與優化。  

Nsight Compute 和 Nsight Systems 是 CUDA 開發者的必備工具，能顯著提升應用程式性能。