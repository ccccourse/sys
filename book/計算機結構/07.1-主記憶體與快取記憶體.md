### 第7章 記憶體系統

記憶體系統在計算機結構中扮演著至關重要的角色，負責儲存程序、數據以及執行過程中的臨時資料。記憶體系統的設計直接影響到計算機的性能。主記憶體（RAM）和快取記憶體（Cache Memory）是其中最為關鍵的兩個組件。本章將詳細介紹主記憶體與快取記憶體的基本概念、工作原理及其在現代計算機中的應用。

### 7.1 主記憶體與快取記憶體

#### 7.1.1 主記憶體（Main Memory）

主記憶體，也稱為隨機存取記憶體（RAM，Random Access Memory），是計算機系統中用來存儲正在運行的程序和數據的主要記憶體。主記憶體通常是計算機系統中最為大量且最為通用的存儲設備，其容量一般比其他類型的記憶體（如快取記憶體或硬碟）大得多。

主記憶體的特點包括：

1. **隨機存取性**：主記憶體的每個位置都可以在同等的時間內直接存取，即無論資料儲存在記憶體中的哪個位置，CPU都可以隨時讀取或寫入。
2. **易失性**：主記憶體在系統斷電後會丟失其中的所有數據。因此，主記憶體主要用來儲存當前運行的程序和數據，而非長期儲存資料。
3. **速度相對較慢**：相比於處理器的寄存器和快取記憶體，主記憶體的讀寫速度較慢，因此對處理器性能的提升相對有限。

主記憶體通常是由數百萬個存儲單元組成，每個存儲單元儲存一個位元（bit），而多個位元組成一個字（word），通常是32位或64位。常見的主記憶體技術有動態隨機存取記憶體（DRAM）和靜態隨機存取記憶體（SRAM）。

- **DRAM（Dynamic RAM）**：DRAM是目前最常用的主記憶體類型。它的工作原理是依賴電容儲存電荷來表示二進位數據（0或1），但由於電容會隨時間慢慢放電，因此需要定期刷新來保持數據。
- **SRAM（Static RAM）**：SRAM使用觸發器來存儲數據，並不需要像DRAM那樣不斷刷新，因此存取速度更快，但其成本和功耗較高，容量通常較小，主要用於快取記憶體中。

#### 7.1.2 快取記憶體（Cache Memory）

快取記憶體是一種比主記憶體速度更快、但容量較小的記憶體，主要用來存儲處理器最近使用的數據或指令。快取記憶體的作用是減少CPU與主記憶體之間的速度差異，從而提高處理器的性能。

快取記憶體通常被劃分為幾級，最常見的是L1、L2和L3快取，分別代表不同層級的快取記憶體：

1. **L1快取**：L1快取是最靠近處理器的快取，通常集成在處理器芯片內部。L1快取的容量較小，通常在16KB到64KB之間，但其存取速度極快，能在極短的時間內提供數據。
2. **L2快取**：L2快取比L1快取容量大，通常在128KB到256KB之間，但存取速度相對較慢。L2快取有時也會集成在處理器內部，但也可能設置在處理器外部，作為與L1快取的補充。
3. **L3快取**：L3快取通常是多核處理器共享的快取，容量比L2快取更大，通常在數MB（例如4MB到16MB）之間，存取速度相對較慢，但它能夠在多核處理器中有效地協調數據共享。

快取記憶體的設計旨在減少處理器與主記憶體之間的等待時間，這是因為處理器在訪問記憶體時會遇到**記憶體延遲（Memory Latency）**。當處理器需要訪問的數據不在快取中時，才需要從主記憶體讀取，這樣會引起較大的延遲。若數據已經被預先儲存在快取記憶體中，則可以避免這種延遲。

#### 7.1.3 快取記憶體的工作原理

快取記憶體利用一種稱為**局部性原則**（Locality Principle）的設計理念來提高效率。局部性原則分為兩種類型：

1. **時間局部性（Temporal Locality）**：指的是在短時間內，程序會重複訪問相同的數據或指令。因此，若某個數據被訪問過，它很可能會在不久後再次被訪問，這使得將數據保存在快取中變得有意義。
2. **空間局部性（Spatial Locality）**：指的是當程序訪問某個記憶體位置時，該位置附近的數據也很可能會被訪問。因此，快取不僅會存儲單一的數據，還可能會將數據塊存儲在快取中，以提高後續的存取效率。

當處理器需要讀取數據時，首先會查看L1快取，如果數據不存在於L1快取中，則查詢L2快取，依此類推。如果在所有快取層級中都未找到所需數據，則最終會從主記憶體中讀取該數據，這一過程稱為**快取未命中（Cache Miss）**。當數據被成功讀取並放入快取中後，處理器可以利用快取提供更快的存取速度。

#### 7.1.4 快取記憶體的替換策略

當快取記憶體滿時，需要選擇一個策略來決定哪些數據應該被替換出快取。常見的替換策略包括：

1. **最不常用（Least Recently Used, LRU）**：選擇最近最少使用的數據進行替換。
2. **最不經常使用（Least Frequently Used, LFU）**：選擇使用頻率最低的數據進行替換。
3. **隨機替換（Random Replacement）**：隨機選擇一個數據進行替換。

#### 7.1.5 主記憶體與快取記憶體的協同工作

主記憶體與快取記憶體在計算機系統中協同工作，快取記憶體減少了CPU等待主記憶體的時間，而主記憶體則提供大容量的數據儲存。快取記憶體和主記憶體的協同工作確保了系統性能的平衡和最佳化。

1. **快取命中（Cache Hit）**：當所需數據存在於快取中時，CPU可以立即從快取中讀取數據，極大縮短了存取時間。
2. **快取未命中（Cache Miss）**：當所需數據不在快取中時，CPU必須從主記憶體中讀取數據，這會造成延遲。

### 7.1.6 小結

主記憶體和快取記憶體是計算機記憶體系統的兩個重要組件。主記憶體提供大容量的存儲空間，但存取速度相對較慢；而快取記憶體雖然容量較小，但速度極快，能有效減少處理器等待主記憶體的時間。兩者的協同工作能夠大幅提升計算機的整體性能。