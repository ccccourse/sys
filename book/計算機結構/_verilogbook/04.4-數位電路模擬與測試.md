### 4.4 數位電路模擬與測試

數位電路的模擬與測試是設計過程中不可或缺的步驟。通過模擬和測試，設計師能夠在硬體實現之前發現設計中的潛在錯誤，並驗證設計是否符合功能需求。數位電路的模擬包括對組合邏輯、順序邏輯以及其他數位系統的行為進行預測和檢查。

模擬通常涉及對電路進行功能性仿真、時序分析、延遲分析等，而測試則強調對電路的正確性、穩定性及容錯能力進行驗證。模擬與測試的工具有很多，如 ModelSim、Xilinx ISim、Synopsys 等。

在這一章中，我們將介紹數位電路模擬與測試的基本流程、模擬環境設置以及使用 Verilog 進行模擬的實際範例。

### 數位電路模擬的基本流程

數位電路的模擬一般可分為以下幾個步驟：

1. **編寫設計（Design Entry）**：
   設計師使用硬體描述語言（HDL），如 Verilog 或 VHDL，來編寫數位電路的設計程式碼。這些程式碼描述了電路的結構和行為。

2. **編寫測試平台（Testbench）**：
   測試平台是一段用於檢驗設計正確性的程式碼。它模擬輸入信號並觀察設計的輸出，以確保設計能按預期工作。測試平台提供了所需的所有激勵信號，並可進行自動化檢查。

3. **模擬（Simulation）**：
   在模擬過程中，設計程式碼與測試平台一起被送入仿真工具（如 ModelSim 或 ISim）進行仿真。仿真工具會根據模擬的信號及邏輯運算來預測電路的行為。

4. **分析結果（Analysis of Results）**：
   仿真工具會生成波形圖，顯示信號在不同時間點的變化。設計師根據波形圖來檢查設計是否符合預期。若不符合，設計師需要進行修改。

5. **優化與修正（Optimization and Debugging）**：
   根據仿真結果，設計師可以對設計進行優化或修正，並再次進行模擬以檢查改動是否解決了問題。

### 測試平台（Testbench）設計

測試平台是模擬過程中的關鍵組件之一。它通常是獨立於設計本身的，並且模擬設計的各種可能情況，包括邊界條件和極端情況。測試平台通常由以下部分構成：

- **輸入信號的產生**：測試平台會向設計的輸入端口提供各種測試數據，這些數據可以是隨機的，也可以是根據某些已知條件生成的。
- **設計實例的生成**：將設計程式碼實例化，將其連接到測試平台的輸入和輸出端口。
- **結果檢查**：測試平台檢查設計輸出的結果是否符合預期，並將檢查結果報告給設計師。

### Verilog 測試平台範例

假設我們有一個簡單的 AND 閘設計，這是一個組合邏輯電路。我們希望編寫一個測試平台來檢查這個 AND 閘的功能。

#### AND 閘設計（模組）
```verilog
module AND_Gate (
    input wire A, B,    // 輸入端口
    output wire Y       // 輸出端口
);
    assign Y = A & B;   // AND 邏輯操作
endmodule
```

#### 測試平台設計
```verilog
module Testbench;
    // 設計的輸入和輸出
    reg A, B;          // 輸入端口
    wire Y;            // 輸出端口

    // 產生 AND 閘的實例
    AND_Gate uut (
        .A(A),
        .B(B),
        .Y(Y)
    );

    // 測試程序
    initial begin
        // 顯示模擬結果
        $display("A B | Y");
        $display("---------");
        
        // 測試組合情況
        A = 0; B = 0;
        #10; // 等待10個時間單位
        $display("%b %b | %b", A, B, Y);
        
        A = 0; B = 1;
        #10;
        $display("%b %b | %b", A, B, Y);
        
        A = 1; B = 0;
        #10;
        $display("%b %b | %b", A, B, Y);
        
        A = 1; B = 1;
        #10;
        $display("%b %b | %b", A, B, Y);
        
        // 模擬結束
        $finish;
    end
endmodule
```

### 程式碼解析

1. **模組宣告**：測試平台 `Testbench` 並未定義實際的硬體，只負責生成輸入信號並檢查輸出結果。
2. **信號宣告**：`reg` 用於聲明測試平台的輸入端口（`A` 和 `B`），`wire` 用於聲明輸出端口（`Y`）。
3. **設計實例化**：在測試平台中，我們實例化了被測試的 AND 閘模組 `AND_Gate`，並將測試平台的輸入端口和輸出端口與其相對應的信號連接。
4. **測試序列**：在 `initial` 區塊內，我們指定了不同的輸入組合（`A` 和 `B`），並在每組測試後延遲 `#10` 時間單位，這樣做可以模擬不同的時間步驟。每次測試後，通過 `$display` 顯示結果。
5. **仿真結束**：最後，使用 `$finish` 終止模擬。

### 模擬結果

當仿真完成後，模擬工具將顯示如下的輸出結果：

```
A B | Y
---------
0 0 | 0
0 1 | 0
1 0 | 0
1 1 | 1
```

這表示該 AND 閘的行為是符合預期的。

### 結論

數位電路的模擬與測試是確保設計正確性的重要步驟。通過編寫測試平台並執行仿真，設計師可以在實際硬體實現之前發現潛在的問題。Verilog 提供了一種簡便且強大的方式來進行這些測試，並且可以與各種仿真工具配合使用，進行功能模擬、時序分析等。