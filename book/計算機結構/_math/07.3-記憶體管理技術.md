### 7.3 記憶體管理技術

**設計原理：**

記憶體管理技術是操作系統中負責有效利用主記憶體的技術，它決定了如何分配、回收和保護內存。隨著現代計算機系統的發展，記憶體管理的技術越來越複雜，並且涵蓋了從物理記憶體到虛擬記憶體的各種操作。

記憶體管理的主要目的是提供高效的內存分配，避免內存碎片，並確保多個程序能夠在同一時刻平穩運行。操作系統需負責管理所有進程的內存需求，並提供對應的記憶體保護和隔離機制。

**主要記憶體管理技術：**
1. **靜態記憶體分配（Static Memory Allocation）：**
   - 在程序編譯時確定內存分配。
   - 每個進程或程序在啟動時就固定分配內存。
   - 不支持動態內存分配，靜態內存分配的優點是管理簡單，但其缺點是靈活性差，不能有效應對程序需求變化。

2. **動態記憶體分配（Dynamic Memory Allocation）：**
   - 在運行時根據需求動態地分配和回收記憶體。
   - 常用的動態記憶體分配技術包括堆（Heap）和棧（Stack）兩種方式：
     - **堆（Heap）：** 用於動態分配記憶體，分配過程由程式控制。
     - **棧（Stack）：** 用於自動內存管理，當函數返回時自動釋放記憶體。

3. **分頁技術（Paging）：**
   - 將虛擬記憶體和物理記憶體分為固定大小的塊，稱為頁（Page）。
   - 分頁技術的關鍵點在於將虛擬記憶體中的頁映射到物理記憶體中的頁框（Page Frame）。
   - 操作系統會維護一個頁表（Page Table）來記錄每個虛擬頁對應的物理頁框。
   - 分頁有助於避免外部碎片，並且允許更靈活的內存分配，但需要額外的記憶體管理開銷（例如頁表的存儲和查詢）。

4. **段式管理（Segmentation）：**
   - 段式管理將程序的記憶體劃分為不同的段，如代碼段、數據段、堆棧段等。每個段可以具有不同的長度。
   - 與分頁技術相比，段式管理可以提供更靈活的內存分配，但它可能會產生外部碎片，導致內存利用率低下。

5. **虛擬記憶體（Virtual Memory）：**
   - 虛擬記憶體允許程序使用比實際物理內存更多的內存，通過將部分內存頁存儲在磁碟中來擴展記憶體容量。
   - 當程序需要訪問不在物理內存中的頁時，操作系統會從磁碟中加載所需的頁，並將其替換到主記憶體中。
   - 虛擬記憶體的實現依賴於分頁技術，且會有頁面替換算法，如LRU（Least Recently Used）或FIFO（First-In-First-Out）。

6. **內存保護（Memory Protection）：**
   - 內存保護機制用來防止不同進程之間互相干擾。操作系統可以通過頁表中的保護位來指定哪些頁是可讀的、可寫的或不可訪問的。
   - 這樣做能夠保護操作系統內核區域或一個進程的私有資料不被其他進程誤操作。

**數學模型與效能考量：**

1. **內存碎片：**
   - 內存碎片是指內存的空閒區域無法被有效利用，從而導致內存的低效利用。
     - **外部碎片：** 是指內存中有足夠空間來容納進程，但由於空閒區域不連續，無法分配給進程。
     - **內部碎片：** 是指內存分配給進程的區域比進程實際使用的內存要大，造成空間浪費。

   內存碎片的數學建模可以通過**碎片率**（Fragmentation Rate）來衡量，碎片率計算公式如下：

   \[
   \text{碎片率} = \frac{\text{空閒內存}}{\text{總內存}}
   \]

   內存碎片的問題需要依賴於合適的內存分配算法，如首次適應法（First Fit）、最佳適應法（Best Fit）或最差適應法（Worst Fit）。

2. **頁表查詢與虛擬記憶體存取時間：**
   在使用虛擬記憶體的情況下，操作系統需要查詢頁表來將虛擬地址映射到物理地址。這會產生額外的查詢延遲。頁表查詢的延遲通常為幾個時鐘週期。若發生頁面未命中，則會引發頁面替換中斷，需要額外的磁碟存取時間。

   假設：
   - 每次頁表查詢的時間為 \( T_{\text{page\_table}} \)
   - 每次磁碟存取時間為 \( T_{\text{disk}} \)
   - 頁面未命中的機率為 \( P_{\text{miss}} \)

   那麼虛擬記憶體的總存取時間（\( T_{\text{total}} \)）可以計算為：

   \[
   T_{\text{total}} = T_{\text{memory}} + T_{\text{page\_table}} + P_{\text{miss}} \times T_{\text{disk}}
   \]

   這個公式考慮了內存存取時間、頁表查詢延遲和頁面未命中時磁碟存取所需的額外時間。

**舉例：**

假設：
- 主記憶體存取時間 \( T_{\text{memory}} = 100 \, \text{ns} \)
- 頁表查詢時間 \( T_{\text{page\_table}} = 10 \, \text{ns} \)
- 磁碟存取時間 \( T_{\text{disk}} = 10 \, \text{ms} = 10,000,000 \, \text{ns} \)
- 頁面未命中率 \( P_{\text{miss}} = 0.05 \)（即5%的時間會觸發頁面交換）

則總存取時間 \( T_{\text{total}} \) 計算如下：

\[
T_{\text{total}} = 100 + 10 + 0.05 \times 10,000,000 = 100 + 10 + 500,000 = 500,110 \, \text{ns}
\]

這顯示了頁面未命中對性能的重大影響，因此，在設計虛擬記憶體系統時需要盡量降低未命中率。

**結論：**

記憶體管理技術的核心目的是在不同進程、任務或應用之間高效地分配和管理內存。通過適當的內存分配算法和技術，如分頁、段式管理和虛擬記憶體，可以有效地提升系統的內存利用率，並改善計算機系統的性能。在設計這些技術時，必須考慮到內存碎片、頁面未命中等因素，並利用數學模型來優化系統的效能。