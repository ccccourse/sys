### 8.1 I/O 設備與控制

**設計原理：**

I/O (Input/Output) 設備是計算機系統與外部環境進行資料交換的橋樑。I/O設備可以分為兩類：輸入設備（例如鍵盤、滑鼠、觸控螢幕）和輸出設備（例如顯示器、打印機、音響設備）。所有這些設備都需要經由I/O控制器來與中央處理器 (CPU) 進行數據交換。I/O控制系統的設計需考慮以下幾個關鍵原則：

1. **資料傳輸方式：**
   - **輪詢（Polling）：** CPU定期檢查I/O設備的狀態，若設備準備好則進行數據傳輸。
   - **中斷（Interrupt）：** 當I/O設備準備好資料時，會中斷CPU的工作，通知CPU進行處理。
   - **DMA（Direct Memory Access）：** 允許I/O設備直接與記憶體進行資料傳輸，減少CPU的負擔。

2. **I/O控制器：** I/O控制器是一個特殊的硬體組件，負責將來自I/O設備的數據傳送至CPU，或將來自CPU的數據傳送至I/O設備。控制器的功能包括：
   - 轉換數據格式（例如從並行到串行）
   - 管理數據的讀取與寫入
   - 處理中斷信號
   - 管理I/O設備的狀態

3. **I/O端口：** 每個I/O設備都需要通過I/O端口與CPU進行通訊。端口可以是記憶體映射（Memory-mapped）或是I/O映射（I/O-mapped）。記憶體映射方式是將I/O設備的控制寄存器映射到內存空間中，而I/O映射則會將I/O設備寄存器映射到專用的I/O端口。

**數學模型與效能考量：**

I/O設備的效能取決於多個因素，包括傳輸速率、延遲、以及資料處理的方式（輪詢、中斷、DMA）。計算I/O操作的總時間可考慮以下三個方面：

1. **資料傳輸時間：** 這是從I/O設備向CPU傳送資料或反向的時間。傳輸時間可以用以下公式計算：
   
   \[
   T_{\text{transfer}} = \frac{\text{Data Size}}{\text{Transfer Rate}}
   \]

   其中：
   - **Data Size** 是要傳輸的資料量（例如，位元組數量）。
   - **Transfer Rate** 是I/O設備的資料傳輸速率（例如，位元每秒或字節每秒）。

2. **輪詢延遲：** 若使用輪詢，CPU需要不斷檢查I/O設備的狀態。輪詢延遲是指每次輪詢間的間隔時間，通常可以表示為：

   \[
   T_{\text{polling}} = \text{Polling Interval} \times \text{Polling Count}
   \]

   在這裡，**Polling Interval** 是CPU進行一次輪詢所需的時間，而 **Polling Count** 是需要檢查的次數。

3. **中斷延遲：** 當使用中斷時，I/O設備會向CPU發送中斷信號，要求其處理數據。中斷延遲通常包括中斷請求的處理時間，以及CPU從當前任務切換到中斷處理例程的時間。可以表示為：

   \[
   T_{\text{interrupt}} = T_{\text{interrupt\_service}} + T_{\text{context\_switch}}
   \]

   其中：
   - **T_{\text{interrupt\_service}}** 是中斷服務例程的處理時間。
   - **T_{\text{context\_switch}}** 是上下文切換時間，即從當前執行的程序切換到中斷處理程序的時間。

4. **DMA延遲：** 在DMA模式下，I/O設備直接與內存進行數據交換，不需要CPU介入，因此會顯著減少CPU的負擔。DMA傳輸時間可以表示為：

   \[
   T_{\text{DMA}} = \frac{\text{Data Size}}{\text{DMA Rate}}
   \]

   其中，**DMA Rate** 是DMA傳輸的速率。

**舉例：**

假設一個輸出設備（如顯示器）需要將一個 1024x768 像素的圖片顯示到螢幕上，每個像素佔用 32 位元（即 4 字節）。若顯示器的資料傳輸速率為 1 Gbps（即 \(1 \times 10^9 \) 位元每秒），輪詢時間為每 10 微秒輪詢一次，而中斷服務的時間為 200 微秒。

1. **資料傳輸時間：**

   首先，計算需要傳輸的總數據量：
   \[
   \text{Data Size} = 1024 \times 768 \times 4 \, \text{bytes} = 3,145,728 \, \text{bytes}
   \]
   然後，計算資料傳輸時間：
   \[
   T_{\text{transfer}} = \frac{3,145,728 \times 8}{1 \times 10^9} = 0.025 \, \text{seconds} = 25 \, \text{milliseconds}
   \]

2. **輪詢延遲：**

   假設每次輪詢檢查顯示器是否準備好，且輪詢時間為 10 微秒，則每秒進行的輪詢次數為：
   \[
   T_{\text{polling}} = 10 \, \mu s \times 100,000 \, \text{pulses per second} = 1 \, \text{second}
   \]

3. **中斷延遲：**

   假設每次中斷服務所需的時間為 200 微秒，則處理延遲為：
   \[
   T_{\text{interrupt}} = 200 \, \mu s
   \]

4. **DMA延遲：**

   若DMA資料傳輸速率為 500 MB/s，則DMA傳輸時間為：
   \[
   T_{\text{DMA}} = \frac{3,145,728}{500 \times 10^6} = 6.29 \, \text{milliseconds}
   \]

**結論：**

在I/O設備和控制的設計中，選擇適當的資料傳輸方式（輪詢、中斷、DMA）對效能有重要影響。輪詢簡單但效率較低，因為它需要持續檢查I/O設備的狀態；中斷能有效地減少CPU的空閒時間，但會有一定的中斷延遲；DMA模式則提供了最高效的資料傳輸方式，尤其適用於大數據量的操作。對於不同應用場景，需要根據實際需求選擇合適的I/O控制方案。