### **7. 用 Scapy 驗證 C 發送的封包**

在低階網路程式設計中，我們可以使用 C 手動構造和發送封包，但為了檢查封包是否按照預期發送並成功抵達目標，我們可以使用 **Scapy** 來捕獲並分析這些封包。Scapy 是一個強大的 Python 庫，用於封包構造、發送、捕獲和分析。我們將展示如何使用 Scapy 來驗證我們使用 C 發送的封包是否符合預期。

### **1. 為何使用 Scapy 驗證封包？**

Scapy 可以用來捕獲從網路中傳送的封包，並對它們進行分析。它能夠解析各種網路協定，包括 IP、TCP、UDP、ICMP 等，並顯示封包的詳細結構。這使得它成為檢查和驗證低階網路程式設計中發送的封包的理想工具。

### **2. 使用 Scapy 捕獲和驗證封包的基本流程**

1. **設定網路介面**：首先，我們需要配置 Scapy 來監聽指定的網路介面，以捕獲來自 C 程式發送的封包。
   
2. **捕獲封包**：使用 Scapy 的 `sniff()` 函數來捕獲網路上的封包。可以設置過濾條件，只捕獲特定的封包。

3. **解析封包**：當 Scapy 捕獲到封包後，我們可以使用 Scapy 內建的解析功能來解析 IP、TCP 標頭，並檢查封包的內容。

4. **驗證封包內容**：將捕獲到的封包與我們在 C 程式中構造的封包進行比較，確保它們的源 IP、目的 IP、源端口、目的端口等符合預期。

### **3. 使用 Scapy 捕獲和解析封包**

首先，我們需要安裝 Scapy。如果還沒安裝，可以使用以下命令進行安裝：

```bash
pip install scapy
```

接下來，這是一個使用 Scapy 捕獲並驗證 C 程式發送的封包的範例程式：

```python
from scapy.all import sniff, IP, TCP

# 設定捕獲的過濾器，只捕獲來自源 IP 和目的端口的封包
def packet_callback(packet):
    if packet.haslayer(IP) and packet.haslayer(TCP):
        ip_src = packet[IP].src
        ip_dst = packet[IP].dst
        tcp_sport = packet[TCP].sport
        tcp_dport = packet[TCP].dport
        print(f"捕獲封包：")
        print(f"源 IP: {ip_src}, 目的 IP: {ip_dst}")
        print(f"源端口: {tcp_sport}, 目的端口: {tcp_dport}")
        print(f"封包內容: {packet.summary()}")
        # 進行驗證，檢查是否符合預期
        if ip_src == "192.168.1.100" and ip_dst == "192.168.1.1" and tcp_sport == 12345 and tcp_dport == 80:
            print("封包符合預期！")
        else:
            print("封包不符合預期！")

# 開始捕獲封包，並指定監聽的介面
sniff(prn=packet_callback, filter="ip", store=0)
```

### **4. 程式解釋**

1. **設定過濾器**：
   - 在 `sniff()` 函數中，我們可以使用 `filter` 參數來設置過濾器。這個過濾器將限制捕獲特定類型的封包。在此例中，我們使用 `filter="ip"`，表示只捕獲 IP 封包。也可以使用更具體的過濾條件，比如 `filter="ip and tcp"` 來只捕獲 IP 和 TCP 的封包。

2. **封包回調函數**：
   - `packet_callback()` 函數會在每次捕獲到封包時執行。在這裡，我們檢查封包是否包含 IP 和 TCP 層，如果是，就解析源 IP、目的 IP、源端口和目的端口。

3. **封包驗證**：
   - 在回調函數中，我們將捕獲的封包的 IP 和 TCP 屬性與我們預期的結果進行比較（源 IP 和目的 IP 以及源端口和目的端口）。如果符合預期，我們輸出 "封包符合預期！"，否則輸出 "封包不符合預期！"。

4. **捕獲封包**：
   - `sniff()` 函數會開始捕獲網路上的封包。這裡設置了 `store=0`，意味著不會儲存捕獲的封包，只是處理每一個捕獲的封包。

### **5. 捕獲封包並分析**

一旦 Scapy 開始捕獲封包並打印信息，我們就可以檢查其輸出。它會顯示所有捕獲的封包及其相關信息，並告訴我們這些封包是否符合我們在 C 程式中發送的內容。

例如，假設我們在 C 程式中發送的封包的源 IP 是 `192.168.1.100`，目的 IP 是 `192.168.1.1`，源端口是 `12345`，目的端口是 `80`。如果 Scapy 捕獲到的封包符合這些條件，它會打印 "封包符合預期！"，並顯示封包的詳細內容。

### **6. 小結**

使用 Scapy 驗證 C 程式發送的封包能夠幫助我們確保封包的構造正確，並能夠在發送之前檢查封包的內容。這樣不僅有助於網路程式設計中的除錯，還能夠幫助我們更好地理解網路協定和低階網路通訊的細節。