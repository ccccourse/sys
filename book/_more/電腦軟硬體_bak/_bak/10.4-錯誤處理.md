### 10.4 錯誤處理

在組譯過程中，錯誤處理是確保編譯過程順利進行的重要部分。由於組譯器將高階語言或組合語言的指令轉換為機器碼，這一過程中可能會發生多種錯誤。錯誤處理不僅限於語法錯誤的檢查，還需要處理語義錯誤、語法錯誤、內存溢出等各種問題。良好的錯誤處理機制可以幫助開發者識別錯誤並迅速修正，從而提高程式的穩定性和可靠性。

#### 1. 錯誤的分類

錯誤可以根據其性質劃分為不同的類型，主要包括以下幾種：

1. **語法錯誤（Syntax Errors）**：
   語法錯誤通常是由於程式碼格式不正確或不符合語言的語法規則所引起的。例如，丟失括號、拼寫錯誤等。這些錯誤通常是在組譯器的解析階段被發現的。

   範例：
   ```assembly
   MOV AX, ; 缺少源操作數
   ```

2. **語義錯誤（Semantic Errors）**：
   語義錯誤是指雖然語法正確，但指令的意思不符合語言規範或邏輯錯誤。例如，使用未定義的變數，或者寄存器和記憶體操作數類型不匹配。

   範例：
   ```assembly
   MOV AX, BX   ; 此時 AX 和 BX 的資料型別應該匹配，否則會產生語義錯誤
   ```

3. **運行時錯誤（Runtime Errors）**：
   運行時錯誤通常是在程式執行過程中發生的錯誤，如除以零、無效記憶體訪問等。雖然這些錯誤通常不會在編譯時期發現，但它們會導致程式在執行時崩潰。

   範例：
   ```assembly
   DIV AX, 0   ; 除以零會引發運行時錯誤
   ```

4. **鏈接錯誤（Linker Errors）**：
   鏈接錯誤是在組譯器將多個目標檔案和庫文件鏈接成最終可執行文件時發生的錯誤。這些錯誤通常由於未正確設置符號表、無法找到必要的函式庫等原因造成。

   範例：
   ```assembly
   EXTERNAL func   ; 未正確定義外部函數，會引起鏈接錯誤
   ```

5. **內存錯誤（Memory Errors）**：
   內存錯誤通常是在程式訪問未分配的內存位置、超出陣列邊界、或發生內存溢出時引起的錯誤。

   範例：
   ```assembly
   MOV AX, [1000h]  ; 該地址可能未分配或不合法
   ```

#### 2. 錯誤處理的過程

在組譯過程中，錯誤處理的過程可以分為以下幾個步驟：

1. **錯誤檢測**：
   組譯器需要檢查源代碼中的錯誤，這通常在語法解析和語義分析階段進行。組譯器將源代碼轉換為語法樹，並檢查各種可能的語法錯誤和語義錯誤。例如，組譯器會檢查指令的格式、操作數的合法性、變數是否已定義等。

2. **錯誤報告**：
   當組譯器檢測到錯誤時，它應該生成清晰的錯誤信息，告訴開發者出錯的位置和錯誤的類型。錯誤報告應該包括以下內容：
   - 錯誤類型（語法錯誤、語義錯誤等）
   - 出錯的行號
   - 錯誤的具體描述
   - 可能的修正建議

   例如，對於語法錯誤，組譯器可能會顯示如下的錯誤信息：
   ```
   錯誤：第 10 行語法錯誤，缺少源操作數。
   ```

3. **錯誤修正提示**：
   為了幫助開發者更快地修正錯誤，組譯器有時會提供修正錯誤的建議。例如，如果變數未定義，組譯器可以提示開發者檢查是否正確定義了該變數。

4. **繼續編譯或停止**：
   當錯誤被檢測並報告後，組譯器可以選擇繼續編譯過程，將其他部分的代碼進行處理，或者直接停止編譯。對於致命錯誤，組譯器通常會停止編譯並返回錯誤信息；而對於非致命錯誤，組譯器可能會繼續處理其他代碼，並將錯誤信息報告給開發者。

   例如，如果發現語法錯誤，組譯器可能會停止並顯示錯誤信息：
   ```
   錯誤：第 10 行語法錯誤，缺少源操作數。
   編譯停止。
   ```

   而對於較小的錯誤，組譯器可能會繼續處理並在後續步驟中發現更多錯誤。

5. **錯誤修復與重試**：
   開發者根據錯誤報告進行修正後，重新運行組譯器進行編譯，直到代碼無錯誤為止。此過程可能會反覆進行，直到所有錯誤都被修正。

#### 3. 常見錯誤處理技術

1. **回溯法（Backtracking）**：
   回溯法是一種錯誤處理技術，組譯器可以根據錯誤的類型，回溯到上一步的操作，嘗試不同的選擇來解決問題。例如，當遇到語法錯誤時，組譯器可以嘗試跳過某些步驟或用不同的解析方法來繼續處理。

2. **錯誤恢復（Error Recovery）**：
   錯誤恢復技術通常用於語法錯誤的處理。當組譯器遇到語法錯誤時，它會採取措施繼續解析剩餘部分，盡量減少錯誤的影響。這種方法可以幫助編譯器在遇到錯誤時不會完全停止工作，從而有機會在編譯過程中發現更多的錯誤。

3. **錯誤抑制（Error Suppression）**：
   錯誤抑制技術指的是在處理某些錯誤時，組譯器可能會選擇忽略某些錯誤，繼續編譯過程，並在最後進行錯誤統計和報告。這通常用於非致命錯誤的情況。

#### 4. 小結

錯誤處理是組譯過程中的一個重要方面。良好的錯誤處理可以提高組譯器的健壯性，幫助開發者快速發現並修正錯誤。組譯器需要能夠檢測各種錯誤，包括語法錯誤、語義錯誤和運行時錯誤，並提供清晰的錯誤報告和修正建議。在錯誤發生時，組譯器應該採取有效的錯誤恢復和回溯措施，以確保編譯過程的順利進行。