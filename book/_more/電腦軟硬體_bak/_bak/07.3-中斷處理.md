### 7.3 中斷處理

中斷處理是計算機系統中重要的技術之一，它允許外部或內部事件在不斷中斷正常程序執行的情況下，通知 CPU 進行特殊處理。中斷機制能夠提高系統的反應速度和效率，並使 CPU 能夠處理多個並發事件。中斷處理的設計在多任務處理、即時反應系統以及嵌入式系統等方面具有關鍵性作用。

#### 1. 中斷的基本概念

中斷是指當發生某些外部或內部事件時，CPU 當前的運算被暫停，並轉而去執行一段預定的程式碼（通常是中斷處理程序）。當中斷處理程序執行完畢後，CPU 會返回中斷發生前的位置，繼續之前的工作。

中斷有兩種基本類型：

- **硬體中斷（Hardware Interrupt）**：由外部硬體設備發起的中斷，例如 I/O 裝置、網絡卡或計時器的中斷。硬體中斷通常是用來通知 CPU 有外部事件需要處理。
- **軟體中斷（Software Interrupt）**：由程式內部的操作觸發的中斷，例如系統呼叫（System Call）或程式錯誤。軟體中斷通常由程式控制，並用來觸發操作系統或硬體的特定功能。

#### 2. 中斷處理流程

中斷處理的基本流程如下：

1. **中斷發生**：當外部設備或內部事件發生時，會產生一個中斷信號。這個信號通知 CPU 停止當前的任務，並處理中斷。
   
2. **中斷請求（Interrupt Request, IRQ）**：外部設備（如 I/O 裝置）向 CPU 發出中斷請求。當這些請求進來時，處理器會根據中斷優先級來決定先處理哪一個中斷。

3. **保存上下文（Context Saving）**：CPU 停止當前執行的任務並保存其運行狀態（上下文），以便在中斷處理完成後能夠返回原來的狀態。通常會將程式計數器（PC）、寄存器的值等保存到堆疊或記憶體中。

4. **中斷服務程序（Interrupt Service Routine, ISR）**：CPU 轉到預先定義的中斷服務程序。ISR 是一段專門處理中斷事件的程式碼，它會執行一系列操作來處理中斷源。例如，處理 I/O 操作完成的信號、設備錯誤處理等。

5. **恢復上下文（Context Restoring）**：中斷處理程序執行完畢後，CPU 會恢復之前保存的上下文狀態。這樣可以保證中斷發生前的任務繼續執行，從中斷處理中斷的地方恢復。

6. **繼續執行原程式**：CPU 會返回原來的程式，繼續執行未完成的指令。這樣，系統能夠有效地響應外部或內部事件，並且保持高效的多任務處理。

#### 3. 中斷的優先級

由於計算機系統可能會同時接收到多個中斷信號，因此需要確定它們的處理順序。為此，通常會設定中斷的優先級。較高優先級的中斷會被優先處理，而較低優先級的中斷則會被延遲處理。常見的中斷優先級設計有以下幾種：

- **固定優先級（Fixed Priority）**：每個中斷源有一個固定的優先級，這些優先級在設計時就已經確定。當多個中斷同時發生時，CPU 會根據這些優先級來決定處理的順序。
  
- **動態優先級（Dynamic Priority）**：優先級會根據當前系統狀況來進行調整。例如，一些系統可能根據中斷請求的頻率或緊急程度來動態調整中斷的優先級。

- **輪詢優先級（Round-robin Priority）**：這種優先級調度方式通常會按照一個循環順序來處理中斷，特別適用於處理多個相同優先級的中斷。

#### 4. 中斷向量表

中斷向量表（Interrupt Vector Table, IVT）是處理器用來查找中斷服務程序的資料結構。它是一個存儲中斷服務例程地址的表格，每一個中斷源（如 I/O 裝置、計時器等）都有對應的一個入口點。在中斷發生時，CPU 查詢該表，並跳轉到對應的中斷服務程序進行處理。

#### 5. 中斷屏蔽

在某些情況下，系統可能需要臨時關閉某些中斷的處理，以避免中斷處理過程中出現競爭條件或其他問題。這種操作被稱為中斷屏蔽（Interrupt Masking）。

中斷屏蔽可以根據需要屏蔽特定中斷，也可以全局屏蔽所有中斷。例如，在進行關鍵操作時，系統可以屏蔽外部設備的中斷，以防止干擾操作的順利完成。完成操作後，再恢復中斷處理。

#### 6. 中斷類型

中斷通常分為以下幾類：

- **硬體中斷**：來自外部設備（如鍵盤、顯示卡、網絡卡等）的請求。硬體中斷通常用來通知 CPU 處理某些事件（例如 I/O 操作完成）。

- **軟體中斷**：來自軟體（如程式內部的系統呼叫）或操作系統的請求。軟體中斷通常用來觸發某些操作系統功能（如文件操作、記憶體分配等）。

- **時鐘中斷**：由計時器或時鐘產生，用於管理時間控制，尤其是在多任務系統中，時鐘中斷會用來實現任務的時間片輪替。

- **異常（Exception）**：異常是一種特殊的中斷，通常是由程式錯誤或不正當操作（如除以零、非法指令等）觸發的。

#### 7. 中斷處理的效率

中斷處理的效率對整體系統性能至關重要。以下是影響中斷處理效率的幾個因素：

- **中斷響應時間（Interrupt Latency）**：是指從中斷信號發出到 CPU 開始執行中斷處理程序所需的時間。中斷響應時間越短，系統反應越快。
  
- **中斷處理時間（Interrupt Handling Time）**：是指從中斷處理程序開始執行到處理完成所需的時間。中斷處理時間越短，系統就能更快速地恢復正常工作。

- **中斷嵌套**：當中斷發生在中斷服務程序內部時，會形成中斷嵌套。過多的中斷嵌套可能會導致處理過程複雜，從而降低系統效能。

#### 8. 中斷處理的應用

中斷處理廣泛應用於許多領域，包括但不限於：

- **多任務操作系統**：中斷可以用來實現任務切換，讓 CPU 在多個任務之間進行快速切換，提高系統的並發處理能力。
  
- **即時系統（Real-Time Systems）**：在即時系統中，中斷用來快速響應外部事件，保證系統在特定的時間內完成特定任務。

- **嵌入式系統**：嵌入式系統中，中斷可以用來管理與硬體裝置的互動，提高系統的效能和響應速度。

#### 9. 結論

中斷處理是現代計算機系統中的一項關鍵技術，它允許 CPU 在不中斷正常工作的情況下快速處理外部或內部事件。透過有效的中斷管理和中斷處理，計算機系統能夠提高並發處理能力、增強反應速度，並支持多任務操作。中斷的效率和設計對系統性能具有深遠影響，是硬體與軟體協同運作的核心技術之一。